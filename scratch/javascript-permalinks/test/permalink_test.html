<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>JavaScript unit test file</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src="assets/jsunittest.js" type="text/javascript"></script>
    <script src="../permalinks.user.js" type="text/javascript"></script>
    <link rel="stylesheet" href="assets/unittest.css" type="text/css" />
  </head>
  <body>

    <div id="content">

      <div id="header">
        <h1>JavaScript unit test file</h1>
      </div>

      <!-- Log output (one per Runner, via {testLog: "testlog"} option)-->
      <div id="testlog"></div>
  
      <!-- Put sample/test html here -->
      <div id="sample">
      </div>
    </div>

    <script type="text/javascript">
    // <![CDATA[
      new Test.Unit.Runner({
        setup: function() {
          Permalink.rules = []; // Reset the rules array
          this.locationProxy = document.createElement('a');
        },
    
        teardown: function() {
      
        },

        'test should generate the permalink for a url using a callback function': function() { with(this) {
          var rule = {
            'urlPattern' : /cgi\.ebay\.co\.uk/,
            'modifier'   : function(url) {
              var queryString = new Url(url).queryString();
              var hash = queryString.hash;
              if (m = hash.match(/item(\d+)/)) {
                var itemId = m[1];
                return 'http://cgi.ebay.co.uk/ws/eBayISAPI.dll?ViewItem&item=' + itemId;
              }
            }
          }
          Permalink.rules.push(rule);
          this.locationProxy.href = 'http://cgi.ebay.co.uk/Netgear-RangeMax-WPN824-MIMO-Wireless-Router-108MBPS_W0QQitemZ120398909420QQcmdZViewItemQQptZUK_Computing_Networking_SM?hash=item120398909420&_trksid=p3286.c0.m14&_trkparms=72%3A1690|66%3A2|65%3A12|39%3A1|240%3A1308';
          permalink = new Permalink(this.locationProxy);
          
          assertEqual('http://cgi.ebay.co.uk/ws/eBayISAPI.dll?ViewItem&item=120398909420', permalink.href());
        }},
        
        'test should generate the permalink for a url that contains our required key only in the querystring': function() { with(this) {
          var rule = {
            'urlPattern' : /localhost/,
            'key' : 'id'
          }
          Permalink.rules.push(rule);
          this.locationProxy.href = 'http://localhost/?id=123';
          permalink = new Permalink(this.locationProxy)
          
          assertEqual('http://localhost/?id=123', permalink.href());
        }},
        
        'test should generate the permalink for a url that contains our required key within mulitple key and value pairs in the querystring': function() { with(this) {
          var rule = {
            'urlPattern' : /localhost/,
            'key' : 'id'
          }
          Permalink.rules.push(rule);
          this.locationProxy.href = 'http://localhost/?foo=bar&id=123&bar=baz';
          permalink = new Permalink(this.locationProxy)
          
          assertEqual('http://localhost/?id=123', permalink.href());
        }},
        
        'test should generate the permalink for a url when there are multiple rules defined': function() { with(this) {
          var rule1 = {
            'urlPattern' : /localhost/,
            'key' : 'id'
          }
          var rule2 = {
            'urlPattern' : /example\.com/,
            'key' : 'bar'
          }
          Permalink.rules.push(rule1);
          Permalink.rules.push(rule2);
          this.locationProxy.href = 'http://example.com/?foo=bar&id=123&bar=baz';
          permalink = new Permalink(this.locationProxy)
          
          assertEqual('http://example.com/?bar=baz', permalink.href());
        }},
        
        'test should return an empty string if our required key could not be found in the querystring': function() { with(this) {
          var rule = {
            'urlPattern' : /localhost/,
            'key' : 'id'
          }
          Permalink.rules.push(rule);
          this.locationProxy.href = 'http://localhost/?foo=bar&bar=baz';
          permalink = new Permalink(this.locationProxy)
          
          assertEqual('', permalink.href());
        }},
        
        'test should return an empty string if the url pattern in our rule does not match the url of the location object': function() { with(this) {
          var rule = {
            'urlPattern' : /example.com/,
            'key' : 'id'
          }
          Permalink.rules.push(rule);
          this.locationProxy.href = 'http://localhost/?id=123';
          permalink = new Permalink(this.locationProxy);
          
          assertEqual('', permalink.href());
        }}

      }); 
    // ]]>
    </script>
  </body>
</html>