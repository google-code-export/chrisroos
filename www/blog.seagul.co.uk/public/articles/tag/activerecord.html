<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

  <head>
    <meta name="microid" content="ff511e16d7108be450fccd6f4611cf8d1d5416d1" >
    <meta http-equiv="content-type" content="text/html; charset=utf-8" >
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/DeferredUntilInspirationHits" >
    <link rel="stylesheet" href="/stylesheets/yui-reset-fonts-grids.css" type="text/css" media="all">
    <link rel="stylesheet" href="/stylesheets/blog.css" type="text/css" media="screen" charset="utf-8">
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="screen" charset="utf-8">
    <link rel="openid.server" href="http://www.myopenid.com/server">
    <link rel="openid.delegate" href="http://chrisroos.myopenid.com/">
    <title>Posts tagged activerecord - deferred until inspiration hits</title>
  </head>
  
  <body>
    
    <div id="doc3" class="yui-t4">
      <div id="hd">
        <h1><a class="blogTitle" href="/">deferred until inspiration hits</a></h1>
      </div>
      <div id="bd">
        <div id="yui-main">
          <div class="yui-b">
            <div class="yui-g">

              
                <h2>
                  <a href="/articles/2006/08/02/helpful-error-messages-when-active-record-objects-fail-validation-in-tests">Helpful error messages when active record objects fail validation (in tests)</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Wed, 02 Aug 2006 13:47:00">
                    Wed, 02 Aug 2006 13:47:00
                  </span>
                </p>

                <p>I <a href="http://blog.seagul.co.uk/articles/2006/06/21/more-helpful-messages-for-active-record-validation-errors-in-rails-testing">posted</a> a while back about displaying the reasons for an active record model failing validation.</p>


	<p>I knew the code was hacky and nasty but didn&#8217;t realise quite how bad until I noticed how <a href="http://dev.rubyonrails.org/browser/tags/rel_1-1-0/activerecord/lib/active_record/validations.rb">simply</a>  (1 line) the same thing was implemented in <a href="http://weblog.rubyonrails.com/2006/3/28/rails-1-1-rjs-active-record-respond_to-integration-tests-and-500-other-things">Rails 1.1</a> (and above).</p>


	<p>Although it&#8217;s only useful for people still on Rails 1.0, I made a quick plugin that backports this change.  I don&#8217;t really want to put it in my subversion repository, so have just pasted the necessary code below.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="comment"># File init.rb</span>
<span class="ident">require</span> <span class="constant">File</span><span class="punct">.</span><span class="ident">dirname</span><span class="punct">(</span><span class="constant">__FILE__</span><span class="punct">)</span> <span class="punct">+</span> <span class="punct">'</span><span class="string">/lib/record_invalid</span><span class="punct">'</span></code></pre></div>

<div class="typocode"><pre><code class="typocode_ruby"><span class="comment"># File record_invalid.rb</span>
<span class="keyword">module </span><span class="module">ActiveRecord</span>

  <span class="keyword">class </span><span class="class">RecordInvalid</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecordError</span>
    <span class="keyword">def </span><span class="method">initialize</span><span class="punct">(</span><span class="ident">record</span><span class="punct">)</span>
      <span class="attribute">@record</span> <span class="punct">=</span> <span class="ident">record</span>
      <span class="keyword">super</span><span class="punct">(&quot;</span><span class="string">Validation failed: <span class="expr">#{@record.errors.full_messages.join(&quot;, &quot;)}</span></span><span class="punct">&quot;)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>

<span class="keyword">end</span></code></pre></div>

	<p>To create a plugin from this, create the following structure in your rails_app/vendor/plugins directory.</p>


<pre>
active_record_validation_error/
|
|--init.rb (copy contents of code above)
|
|--lib/
   |
   |--record_invalid.rb (copy content of code above)
</pre>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/activerecord" rel="tag">activerecord</a>, 
                    
                      <a href="/articles/tag/plugin" rel="tag">plugin</a>, 
                    
                      <a href="/articles/tag/rails" rel="tag">rails</a>, 
                    
                      <a href="/articles/tag/validation" rel="tag">validation</a>, 
                    
                  </p>
                
              
                <h2>
                  <a href="/articles/2006/07/14/textmate-command-to-display-active-record-column-attributes">Textmate command to display Active Record column attributes</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Fri, 14 Jul 2006 08:18:00">
                    Fri, 14 Jul 2006 08:18:00
                  </span>
                </p>

                <p>I find myself constantly visiting either the console or the mysql command line to check out the attributes (columns) of <a href="http://api.rubyonrails.com/classes/ActiveRecord/Base.html">active record</a> objects.</p>


	<p>I know there is a <a href="http://blogs.pragprog.com/cgi-bin/pragdave.cgi/Tech/Ruby/AnnotateModels.rdoc">plugin</a> by <a href="http://blogs.pragprog.com/cgi-bin/pragdave.cgi">Dave Thomas</a> that places the table structure within the model code itself.  To be honest I&#8217;ve never tried this and it might well suffice (although I&#8217;m not 100% convinced I like the idea).</p>


	<p>Anyhoo, I just spent some time whilst on the train hacking together a basic <a href="http://macromates.com/">textmate</a> command that displays a tooltip containing the table structure.  It&#8217;s very basic (though you wouldn&#8217;t have thought it based on the amount of time it took me together<sup><a href="#fn1">1</a></sup>); but seems to work ok.</p>


	<p><img src="http://farm1.static.flickr.com/236/460082493_49ff4cd1ed_o.png" alt="" /></p>


	<p>The code is below.  You&#8217;ll need to add a ruby command in the ruby textmate bundle, setting the intput to &#8216;selected text&#8217; or &#8216;nothing&#8217;, the output to &#8216;show as tooltip&#8217; and preferably a hotkey that isn&#8217;t one of the ones you use every day (however tempting that is).</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="comment">#! /usr/local/bin/ruby</span>

<span class="ident">project</span> <span class="punct">=</span> <span class="constant">ENV</span><span class="punct">['</span><span class="string">TM_PROJECT_DIRECTORY</span><span class="punct">']</span>
<span class="ident">word</span> <span class="punct">=</span> <span class="constant">ENV</span><span class="punct">['</span><span class="string">TM_CURRENT_WORD</span><span class="punct">']</span>

<span class="ident">require</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{project}</span>/config/boot</span><span class="punct">&quot;</span>
<span class="ident">require</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{project}</span>/config/environment</span><span class="punct">&quot;</span>

<span class="ident">klass</span> <span class="punct">=</span> <span class="constant">Object</span><span class="punct">.</span><span class="ident">const_get</span><span class="punct">(</span><span class="ident">word</span><span class="punct">)</span> <span class="keyword">rescue</span> <span class="constant">nil</span>
<span class="keyword">if</span> <span class="ident">klass</span> <span class="keyword">and</span> <span class="ident">klass</span><span class="punct">.</span><span class="keyword">class </span><span class="class">==</span> <span class="ident">Class</span> <span class="ident">and</span> <span class="ident">klass</span><span class="punct">.</span><span class="ident">ancestors</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span><span class="punct">)</span>
  <span class="ident">columns</span> <span class="punct">=</span> <span class="ident">klass</span><span class="punct">.</span><span class="ident">columns_hash</span>

  <span class="ident">data</span> <span class="punct">=</span> <span class="punct">[]</span>
  <span class="ident">data</span> <span class="punct">+=</span> <span class="punct">[%w[</span><span class="string">column primary sql_type default</span><span class="punct">]]</span>
  <span class="ident">data</span> <span class="punct">+=</span> <span class="punct">[%w[</span><span class="string">------ ------- -------- -------</span><span class="punct">]]</span>
  <span class="ident">data</span> <span class="punct">+=</span> <span class="ident">columns</span><span class="punct">.</span><span class="ident">collect</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">col</span><span class="punct">,</span> <span class="ident">attrs</span><span class="punct">|</span> <span class="punct">[</span><span class="ident">col</span><span class="punct">,</span> <span class="ident">attrs</span><span class="punct">.</span><span class="ident">primary</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="ident">attrs</span><span class="punct">.</span><span class="ident">sql_type</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="ident">attrs</span><span class="punct">.</span><span class="ident">default</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">]</span> <span class="punct">}</span>

  <span class="constant">STDOUT</span> <span class="punct">&lt;&lt;</span> <span class="ident">data</span><span class="punct">.</span><span class="ident">inject</span><span class="punct">('</span><span class="string"></span><span class="punct">')</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">output</span><span class="punct">,</span> <span class="ident">array</span><span class="punct">|</span> 
    <span class="ident">output</span> <span class="punct">+</span> <span class="ident">array</span><span class="punct">.</span><span class="ident">inject</span><span class="punct">('</span><span class="string"></span><span class="punct">')</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">row_str</span><span class="punct">,</span> <span class="ident">value</span><span class="punct">|</span> <span class="ident">row_str</span> <span class="punct">+</span> <span class="ident">value</span><span class="punct">.</span><span class="ident">ljust</span><span class="punct">(</span><span class="number">20</span><span class="punct">)</span> <span class="punct">}</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string"><span class="escape">\n</span></span><span class="punct">&quot;</span>
  <span class="keyword">end</span>
<span class="keyword">elsif</span> <span class="ident">klass</span> <span class="keyword">and</span> <span class="ident">klass</span><span class="punct">.</span><span class="keyword">class </span><span class="class">==</span> <span class="ident">Class</span> <span class="ident">and</span> <span class="keyword">not</span> <span class="ident">klass</span><span class="punct">.</span><span class="ident">ancestors</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span><span class="punct">)</span>
  <span class="constant">STDOUT</span> <span class="punct">&lt;&lt;</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{word}</span> is not an Active Record derived class</span><span class="punct">&quot;</span>
<span class="keyword">else</span>
  <span class="constant">STDOUT</span> <span class="punct">&lt;&lt;</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{word}</span> was not recognised as a class</span><span class="punct">&quot;</span>
<span class="keyword">end</span></code></pre></div>

	<p>It relies on you having your entire rails project (the folder right above app, config, script etc) open in textmate (in order to find the config files).  With that, just click on the name of an active record class (it has to be the actual class name at present, it&#8217;d be cool if it also worked based on the class definition you are currently in too) and hit your hotkey of choice (best to use the one you assigned to this command).  Hey presto, a tooltip containing your table structure.</p>


	<p>One odd thing I&#8217;ve noticed is that it never recognises standard class constants.  It should display &#8216;this is not an active record derived class&#8217; but instead always displays &#8216;was not recognised as a class&#8217;.  Oh well.</p>


	<p>Anyone find this remotely useful or want to finish off what I&#8217;ve started?</p>


	<p>[1] I spent ages trying to develop within the textmate bundle editor before realising it&#8217;d be a helluva lot quicker and easier to develop in textmate proper.  Hmmm.</p>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/activerecord" rel="tag">activerecord</a>, 
                    
                      <a href="/articles/tag/rails" rel="tag">rails</a>, 
                    
                      <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                    
                      <a href="/articles/tag/textmate" rel="tag">textmate</a>, 
                    
                  </p>
                
              
                <h2>
                  <a href="/articles/2006/07/12/using-in-memory-active-record-objects-with-associations-for-testing">Using in memory Active Record objects with associations for testing</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Wed, 12 Jul 2006 01:23:00">
                    Wed, 12 Jul 2006 01:23:00
                  </span>
                </p>

                <p>Hitting the database in testing is bad.</p>


	<p>Something that I&#8217;ve found relatively useful at <a href="http://www.reevoo.com">work</a> is to use real <a href="http://api.rubyonrails.com/classes/ActiveRecord/Base.html">Active Record</a> objects without any persistence (basically use AR#new and not AR#save[!] or AR#create[!]).  When using standard techniques to create the association objects in memory you only get one side of the association at a time.  Consider the following.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="keyword">class </span><span class="class">Person</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span>
  <span class="ident">has_many</span> <span class="symbol">:addresses</span>
<span class="keyword">end</span>
<span class="keyword">class </span><span class="class">Address</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span>
  <span class="ident">belongs_to</span> <span class="symbol">:person</span>
<span class="keyword">end</span>

<span class="comment"># One sided relationship with parent getting access to child</span>
<span class="ident">chris</span> <span class="punct">=</span> <span class="constant">Person</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">home</span> <span class="punct">=</span> <span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span><span class="punct">.</span><span class="ident">build</span>

<span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span><span class="punct">.</span><span class="ident">first</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;home&gt;</span>
<span class="ident">home</span><span class="punct">.</span><span class="ident">person</span>
<span class="punct">=&gt;</span> <span class="constant">nil</span>

<span class="comment"># One sided relationship with child getting access to parent</span>
<span class="ident">home</span> <span class="punct">=</span> <span class="constant">Address</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">chris</span> <span class="punct">=</span> <span class="ident">home</span><span class="punct">.</span><span class="ident">build_person</span>

<span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span>
<span class="punct">=&gt;</span> <span class="punct">[]</span>
<span class="ident">home</span><span class="punct">.</span><span class="ident">person</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;chris&gt;</span>

<span class="comment"># The example above that creates the address first could also have been written as.</span>
<span class="comment"># chris = Person.new</span>
<span class="comment"># home = Address.new(:person =&gt; chris)</span></code></pre></div>

	<p>You can see that in each case, only one side of the relationship has access to the other.  If we were persisting the objects then the relationship would be two way via a database lookup.  We can get a two way relationship in memory; although it has a certain duplication smell about it.  Assuming the same models as above, we can amend the above examples like so.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="comment"># First example</span>
<span class="ident">chris</span> <span class="punct">=</span> <span class="constant">Person</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">home</span> <span class="punct">=</span> <span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span><span class="punct">.</span><span class="ident">build</span><span class="punct">(</span><span class="symbol">:person</span> <span class="punct">=&gt;</span> <span class="ident">chris</span><span class="punct">)</span>

<span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span><span class="punct">.</span><span class="ident">first</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;home&gt;</span>
<span class="ident">home</span><span class="punct">.</span><span class="ident">person</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;chris&gt;</span>

<span class="comment"># Second example</span>
<span class="ident">home</span> <span class="punct">=</span> <span class="constant">Address</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">chris</span> <span class="punct">=</span> <span class="ident">home</span><span class="punct">.</span><span class="ident">build_person</span><span class="punct">(</span><span class="symbol">:addresses</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="ident">home</span><span class="punct">])</span>

<span class="ident">home</span><span class="punct">.</span><span class="ident">person</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;chris&gt;</span>
<span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span><span class="punct">.</span><span class="ident">first</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;home&gt;</span></code></pre></div>

	<p>I&#8217;ve occasionally used this in place of stubbing methods but am still not 100% convinced of the definite benefits one way or another.  I do have some definite disadvantages of stubbing methods (nothing exciting, they&#8217;ve almost certainly been noted by many others in the past) which I&#8217;ll note down at a later date.</p>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/activerecord" rel="tag">activerecord</a>, 
                    
                      <a href="/articles/tag/learning" rel="tag">learning</a>, 
                    
                      <a href="/articles/tag/rails" rel="tag">rails</a>, 
                    
                      <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                    
                  </p>
                
              

            </div>
          </div>
        </div>
        <div class="yui-b">
          <img src="/images/me.jpg" width="170px" height="111px" alt="Me">
          <ul class="navigation">
            <li>
              <a href="/contents">contents</a>
            </li>
            <li>
              <a href="http://flickr.com/photos/chrisjroos">flickr</a>
            </li>
            <li>
              <a href="http://del.icio.us/chrisjroos">del.icio.us</a>
            </li>
          </ul>
          <div id="twitter_div">
            <h3><a href="http://twitter.com/chrisroos">twitter</a></h3>
            <ul id="twitter_update_list"></ul>
          </div>
        </div>
      </div>
    </div>
    <div id="ft">
      <!-- Footer -->
    </div>
    
    <script type="text/javascript" src="http://twitter.com/javascripts/blogger.js"></script>
    <script type="text/javascript" src="http://twitter.com/statuses/user_timeline/chrisroos.json?callback=twitterCallback2&amp;count=5"></script>
  
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      var pageTracker = _gat._getTracker("UA-160238-1");
      pageTracker._initData();
      pageTracker._trackPageview();
    </script>
  </body>

</html>