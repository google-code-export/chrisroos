<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

  <head>
    <!--#include virtual="/includes/_head.html"-->
    <title>In memory sqlite database for rails testing - deferred until inspiration hits</title>
  </head>

  <body>
    
    <div id="doc3" class="yui-t4">
      <div id="hd">
        <!--#include virtual="/includes/_header.html"-->
      </div>
      <div id="bd">
        <div id="yui-main">
          <div class="yui-b">
            <div class="yui-g">

              <h2>In memory sqlite database for rails testing</h2>
            
              <p class="postedOn">
                Posted by Chris Roos
                <span title="Wed, 08 Feb 2006 08:54:00">
                  Wed, 08 Feb 2006 08:54:00
                </span>
              </p>
          
              <p><strong>Update 12th June 2006</strong></p>


	<p>There is now a <a href="http://nubyonrails.com/articles/2006/06/01/san-francisco-sqlite3-memory-tests-asteroids">plugin</a> from <a href="http://nubyonrails.com/">Geoffrey Grosenbach</a> that encapsulates this hack.</p>


	<p><del>-</del></p>


	<p>I finally took some time to get the <a href="http://www.sqlite.org">sqlite</a> in memory database working correctly for testing <a href="http://www.rubyonrails.com">Rails</a> apps.</p>


	<p>It appears to be available by default (appearing in the example database.yml file) as</p>


<div class="typocode"><pre><code class="typocode_default">sqlite3_in_memory_example:
  adapter: sqlite3
  database: &quot;:memory:&quot;</code></pre></div>

	<p>Unfortunately, it doesn&#8217;t appear to be quite as easy as just replacing sqlite3_in_memory_example with test&#8230;  The main problem being that in-memory databases have a tendency not to hang around (odd that).</p>


	<p>My solution (which has every chance of being bad or downright incorrect) is to force the creation of the database in memory at the beginning of the tests.</p>


	<p>The current implementation relies on either schema.rb being present or comprehensive migrations (i.e. you can use migrations to get a database from zero to your current development status).</p>


	<p>If you wish to use the schema.rb approach then uncomment the following line in your environment.rb file.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="ident">config</span><span class="punct">.</span><span class="ident">active_record</span><span class="punct">.</span><span class="ident">schema_format</span> <span class="punct">=</span> <span class="symbol">:ruby</span></code></pre></div>

	<p>Un-commenting this option ensures that the database schema is exported to schema.rb rather than adapter specific sql (ENV_database.sql).</p>


	<p>Add the following code right below the &#8221;# Include your application configuration below&#8221; line in environment.rb.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="keyword">def </span><span class="method">in_memory_database?</span>
  <span class="constant">ENV</span><span class="punct">[&quot;</span><span class="string">RAILS_ENV</span><span class="punct">&quot;]</span> <span class="punct">==</span> <span class="punct">&quot;</span><span class="string">test</span><span class="punct">&quot;</span> <span class="keyword">and</span> 
  <span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span><span class="punct">.</span><span class="ident">connection</span><span class="punct">.</span><span class="keyword">class </span><span class="class">==</span> <span class="ident">ActiveRecord</span><span class="punct">::</span><span class="ident">ConnectionAdapters</span><span class="punct">::</span><span class="ident">SQLiteAdapter</span> <span class="ident">and</span>
  <span class="constant">Rails</span><span class="punct">::</span><span class="constant">Configuration</span><span class="punct">.</span><span class="ident">new</span><span class="punct">.</span><span class="ident">database_configuration</span><span class="punct">['</span><span class="string">test</span><span class="punct">']['</span><span class="string">database</span><span class="punct">']</span> <span class="punct">==</span> <span class="punct">'</span><span class="string">:memory:</span><span class="punct">'</span>
<span class="keyword">end</span>

<span class="keyword">if</span> <span class="ident">in_memory_database?</span>
  <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string">creating sqlite in memory database</span><span class="punct">&quot;</span>
  <span class="ident">load</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{RAILS_ROOT}</span>/db/schema.rb</span><span class="punct">&quot;</span> <span class="comment"># use db agnostic schema by default</span>
<span class="comment">#  ActiveRecord::Migrator.up('db/migrate') # use migrations</span>
<span class="keyword">end</span></code></pre></div>

	<p>The reason for adding this code at this point and not just at the end of the environment file is that you may have further logic in environment that actually relies on the database being present.</p>


	<p>If you are running your tests using rake then it shouldn&#8217;t matter whether you use the schema or migrations to create the database.  This is because the rake test tasks rely on the test database being set-up, which involves exporting the development db schema to file.</p>


	<p>If you wish to run tests individually (which, of course, you do) and you choose to use the schema to create your test scructure, you must make sure that it first exists.  The easiest way is to run the following rake task.</p>


<div class="typocode"><pre><code class="typocode_default">rake db_schema_dump</code></pre></div>

	<p>That should be all there is to it; although I must confess that I&#8217;ve seen additional strange problems when running certain tests against the sqlite in-memory database.  In certain cases I think these may be fixture related.  Where, in <a href="http://www.mysql.org">MySql</a>, you seem to be able to omit required fields (not null) from a fixtures file, sqlite requires their presence.  In other cases; who knows&#8230;</p>


	<h3>Testing your sqlite installation</h3>


	<p>One final note that may be of interest.  When I first started playing with sqlite3 with Ruby it seems that I didn&#8217;t have it installed correctly (relying on pre-installed sqlite and the sqlite3-ruby gem).  As per <a href="http://wiki.rubyonrails.org/rails/pages/HowtoUseSQLite">this article</a> I had to un-install sqlite3-ruby gem and first install the swig port before re-installing sqlite3-ruby gem.  You can test for the correct installation by running the <a href="http://wiki.rubyonrails.com/rails/pages/ActiveRecord">Active Record</a> tests against sqlite by following these steps.</p>


	<ul>
	<li>Change directory to Active Record tests (rails/activerecord/test)</li>
	</ul>


	<ul>
	<li>Run base_test.rb, supplying the location of the sqlite3 connection to the load path.</li>
	</ul>


	<ul>
	<li><code>ruby -I "connections/native_sqlite3/" base_test.rb</code></li>
	</ul>


	<p>You can also run the tests using the sqlite3 in memory connection.  To do so, perform these actions before running the tests as above.</p>


	<ul>
	<li>Remove the standard sqlite3 connection</li>
	</ul>


	<ul>
	<li><code>rm connections/native_sqlite3/connection.rb</code></li>
	</ul>


	<ul>
	<li>Rename in_memory_connection.rb as connection.rb</li>
	</ul>


	<ul>
	<li><code>mv connections/in_memory_connection.rb connections/connection.rb</code></li>
	</ul>


	<p>I&#8217;d suggest doing this against an svn checked out copy of rails, purely due to the these at which the changes can be reverted.</p>


	<h3>Useless stats</h3>


	<p>Changing to in-memory testing shaved about 33% off the running time of our unit tests.</p>
        
              
                <p>
                  Tags 
                  
                    <a href="/articles/tag/rails" rel="tag">rails</a>, 
                  
                    <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                  
                    <a href="/articles/tag/sqlite" rel="tag">sqlite</a>, 
                  
                    <a href="/articles/tag/test" rel="tag">test</a>, 
                  
                </p>
              
          
              <div id="disqus_thread"></div>
              <script type="text/javascript" src="http://disqus.com/forums/deferred-until-inspiration-hits/embed.js"></script>
              <noscript>
                <p><a href="http://deferred-until-inspiration-hits.disqus.com/?url=ref">View the forum thread.</a></p>
              </noscript>

              
                <h2>Legacy Comments</h2>
                <ol class="comments">
                  
                  <li>
                    <p class="postedOn">
                      <strong>
                        
                          Manfred Stienstra
                        
                      </strong>
                      said on Mon, 13 Feb 2006 14:13:44:
                    </p>
                    <p>Thanks, this was really useful. It looks like this isn&#8217;t document anywhere, or I suck at reading documentation.</p>
                  </li>
                  
                  <li>
                    <p class="postedOn">
                      <strong>
                        
                          <a href="http://www.dlbmux.info">Dean</a>
                        
                      </strong>
                      said on Fri, 13 Apr 2007 13:02:08:
                    </p>
                    <p>ActiveRecord::Base.connection.class  ActiveRecord::ConnectionAdapters::SQLiteAdapter and
  Rails::Configuration.new.database_configuration['test']['database']  &#8217;:memory:&#8217;</p>


	<p>- doesn&#8217;t work at mine</p>
                  </li>
                  
                  <li>
                    <p class="postedOn">
                      <strong>
                        
                          <a href="http://www.jayod.info">Mike Johnson</a>
                        
                      </strong>
                      said on Thu, 19 Apr 2007 21:27:04:
                    </p>
                    <p>Dean, for me either</p>
                  </li>
                  
                  <li>
                    <p class="postedOn">
                      <strong>
                        
                          Chris
                        
                      </strong>
                      said on Fri, 20 Apr 2007 13:55:24:
                    </p>
                    <p>Mike and Dean,</p>


	<p>I&#8217;ll need far more details if I&#8217;m to look into the problem.  At least Ruby, Rails, sqlite versions &#8211; probably more that I can&#8217;t think of.  Also, no promises that I&#8217;ll get round to doing anything &#8211; we haven&#8217;t used sqlite with rails for ages so I don&#8217;t have any major interest in getting it to work.</p>


	<p>Chris</p>
                  </li>
                  
                  <li>
                    <p class="postedOn">
                      <strong>
                        
                          Florian
                        
                      </strong>
                      said on Sun, 05 Aug 2007 22:04:05:
                    </p>
                    <p>This should do</p>


	<p><span class="caps">ENV</span>[&#8216;RAILS_ENV&#8217;]  'test' and
ActiveRecord::Base.configurations['test']  {
  &#8216;adapter&#8217; =&gt; &#8216;sqlite3&#8217;,
  &#8216;dbfile&#8217; =&gt; &#8217;:memory:&#8217;
} and
ActiveRecord::Migrator.up(&#8216;db/migrate&#8217;)</p>
                  </li>
                  
                  <li>
                    <p class="postedOn">
                      <strong>
                        
                          <a href="http://www.akitaonrails.com">AkitaOnRails</a>
                        
                      </strong>
                      said on Tue, 27 Nov 2007 15:31:41:
                    </p>
                    <p>I am trying it but it feels like my fixtures are not being loaded into the in-memory database. Is there something I have to do to force it?</p>
                  </li>
                  
                  <li>
                    <p class="postedOn">
                      <strong>
                        
                          Chris
                        
                      </strong>
                      said on Mon, 17 Dec 2007 13:59:44:
                    </p>
                    <p>Hey AkitaOnRails,</p>


	<p>I&#8217;m afraid that I haven&#8217;t used this plugin for a very long time now and it&#8217;d probably take me a while to work out what was going on.  Sorry I can&#8217;t help.</p>
                  </li>
                  
                </ol>
              
              
              

            </div>
          </div>
        </div>
        <div class="yui-b">
          <!--#include virtual="/includes/_navigation.html"-->
        </div>
      </div>
    </div>
    <div id="ft">
      <!-- Footer -->
    </div>
    
    <!--#include virtual="/includes/_twitter.html" -->
    <!--#include virtual="/includes/_delicious.html" -->
    <!--#include virtual="/includes/_google_analytics.html" -->
  </body>

</html>
