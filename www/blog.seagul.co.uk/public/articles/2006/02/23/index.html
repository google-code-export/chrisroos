<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

  <head>
    <!--#include virtual="/includes/_head.html"-->
    <title>Posts published on Thu, 23 February 2006 - deferred until inspiration hits</title>
    <meta name="robots" content="noindex" />
  </head>
  
  <body>
    
    <div id="doc3" class="yui-t4">
      <div id="hd">
        <!--#include virtual="/includes/_header.html"-->
      </div>
      <div id="bd">
        <div id="yui-main">
          <div class="yui-b">
            <div class="yui-g">

              
                <h2>
                  <a href="/articles/2006/02/23/rails-rake-testing-without-database">Rails rake testing without database</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Thu, 23 Feb 2006 16:46:00">
                    Thu, 23 Feb 2006 16:46:00
                  </span>
                </p>

                <p>Continuing from the <a href="http://blog.seagul.co.uk/articles/2006/02/23/rails-testing-without-database">previous post</a>, it appears that the rake testing tasks are also tightly coupled to active record.</p>


	<p>This feels quite dirty, but I&#8217;ve managed to get round it by manipulating the tasks from the outside (they are buried in the rails libs).</p>


	<p>To replicate, create a new file called &#8216;default.rake&#8217; in the lib/tasks/ directory within your rails project, and paste in the following code.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="constant">Rake</span><span class="punct">::</span><span class="constant">Task</span><span class="punct">::</span><span class="constant">TASKS</span><span class="punct">.</span><span class="ident">delete</span><span class="punct">('</span><span class="string">default</span><span class="punct">')</span>
<span class="constant">Rake</span><span class="punct">::</span><span class="constant">Task</span><span class="punct">[</span><span class="symbol">:test_units</span><span class="punct">].</span><span class="ident">instance_variable_set</span><span class="punct">(</span><span class="symbol">:@prerequisites</span><span class="punct">,</span> <span class="punct">[])</span>
<span class="constant">Rake</span><span class="punct">::</span><span class="constant">Task</span><span class="punct">[</span><span class="symbol">:test_functional</span><span class="punct">].</span><span class="ident">instance_variable_set</span><span class="punct">(</span><span class="symbol">:@prerequisites</span><span class="punct">,</span> <span class="punct">[])</span>

<span class="ident">task</span> <span class="symbol">:default</span> <span class="keyword">do</span>
  <span class="constant">Rake</span><span class="punct">::</span><span class="constant">Task</span><span class="punct">[</span><span class="symbol">:test_units</span><span class="punct">].</span><span class="ident">invoke</span>      <span class="keyword">rescue</span> <span class="ident">got_error</span> <span class="punct">=</span> <span class="constant">true</span>
  <span class="constant">Rake</span><span class="punct">::</span><span class="constant">Task</span><span class="punct">[</span><span class="symbol">:test_functional</span><span class="punct">].</span><span class="ident">invoke</span> <span class="keyword">rescue</span> <span class="ident">got_error</span> <span class="punct">=</span> <span class="constant">true</span>
  <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">Test failures</span><span class="punct">&quot;</span> <span class="keyword">if</span> <span class="ident">got_error</span>
<span class="keyword">end</span></code></pre></div>

	<p>Because this relies on the internal implementation of rake (instance variable names and <span class="caps">TASKS</span> constant) it might well do very bad things to versions that aren&#8217;t 0.6.2.</p>


	<p><strong>Update 17:20</strong></p>


	<p>Just realised that I don&#8217;t need most of the code above.  All you actually need in default.rake is as follows.  Stoopid Chris.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="constant">Rake</span><span class="punct">::</span><span class="constant">Task</span><span class="punct">[</span><span class="symbol">:test_units</span><span class="punct">].</span><span class="ident">instance_variable_set</span><span class="punct">(</span><span class="symbol">:@prerequisites</span><span class="punct">,</span> <span class="punct">[])</span>
<span class="constant">Rake</span><span class="punct">::</span><span class="constant">Task</span><span class="punct">[</span><span class="symbol">:test_functional</span><span class="punct">].</span><span class="ident">instance_variable_set</span><span class="punct">(</span><span class="symbol">:@prerequisites</span><span class="punct">,</span> <span class="punct">[])</span></code></pre></div>

                
              
                <h2>
                  <a href="/articles/2006/02/23/rails-testing-without-database">Rails testing without database</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Thu, 23 Feb 2006 08:16:00">
                    Thu, 23 Feb 2006 08:16:00
                  </span>
                </p>

                <p>Just yesterday I wanted to create a very quick rails app that didn&#8217;t rely on a database.</p>


	<p>I removed :active_record from the frameworks loaded in evironment, but apparently this wasn&#8217;t quite enough.  The setup and teardown methods in Test::Unit::TestCase were still attempting to load fixtures (which implies that active record is still present somewhere), which require the presence of a database.  This was causing tests not to run.  Having had a quick look at how active record intercepts the setup and teardown methods, it was relatively simple to stop it from doing so.</p>


	<p>Just add the code below within the Test::Unit::TestCase declaration in test_helper.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="keyword">def </span><span class="method">self.dont_use_fixtures</span>
  <span class="ident">class_eval</span> <span class="keyword">do</span>
    <span class="keyword">def </span><span class="method">self.method_added</span><span class="punct">(</span><span class="ident">method</span><span class="punct">);</span> <span class="keyword">end</span>
    <span class="keyword">def </span><span class="method">setup</span><span class="punct">;</span> <span class="keyword">end</span>
    <span class="keyword">def </span><span class="method">teardown</span><span class="punct">;</span> <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span></code></pre></div>

	<p>This still requires that you add dont_use_fixtures into each test class definition.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="keyword">class </span><span class="class">MyTest</span> <span class="punct">&lt;</span> <span class="constant">Test</span><span class="punct">::</span><span class="constant">Unit</span><span class="punct">::</span><span class="constant">TestCase</span>
  <span class="ident">dont_use_fixtures</span>
  <span class="keyword">def </span><span class="method">test_</span>
    <span class="comment"># my first test</span>
  <span class="keyword">end</span>
<span class="keyword">end</span></code></pre></div>

	<p>Having just written this it&#8217;s obvious now that it would make more sense to not require the declaration in each test class (as we supposedly don&#8217;t even have access to active record).  We should probably also play fair and pass messages back to our parent if method_added isn&#8217;t being called with either setup or teardown.</p>


	<p>The new code becomes (again, in Test::Unit::TestCase definition in test_helper).</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="keyword">def </span><span class="method">self.method_added</span><span class="punct">(</span><span class="ident">method</span><span class="punct">)</span>
  <span class="keyword">super</span> <span class="keyword">unless</span> <span class="punct">[</span><span class="symbol">:setup</span><span class="punct">,</span> <span class="symbol">:teardown</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">method</span><span class="punct">.</span><span class="ident">to_sym</span><span class="punct">)</span>
<span class="keyword">end</span>
<span class="keyword">def </span><span class="method">setup</span><span class="punct">;</span> <span class="keyword">end</span>
<span class="keyword">def </span><span class="method">teardown</span><span class="punct">;</span> <span class="keyword">end</span></code></pre></div>

	<p>This appears to work ok&#8230;</p>

                
              

            </div>
          </div>
        </div>
        <div class="yui-b">
          <!--#include virtual="/includes/_navigation.html"-->
        </div>
      </div>
    </div>
    <div id="ft">
      <!-- Footer -->
    </div>
    
    <!--#include virtual="/includes/_twitter.html" -->
    <!--#include virtual="/includes/_delicious.html" -->
    <!--#include virtual="/includes/_google_analytics.html" -->
  </body>

</html>
