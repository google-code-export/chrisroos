<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

  <head>
    <meta name="microid" content="ff511e16d7108be450fccd6f4611cf8d1d5416d1" >
    <meta http-equiv="content-type" content="text/html; charset=utf-8" >
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/DeferredUntilInspirationHits" >
    <link rel="stylesheet" href="/stylesheets/yui-reset-fonts-grids.css" type="text/css" media="all">
    <link rel="stylesheet" href="/stylesheets/blog.css" type="text/css" media="all" charset="utf-8">
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="all" charset="utf-8">
    <link rel="stylesheet" href="/stylesheets/print.css" type="text/css" media="print" charset="utf-8">
    <link rel="openid.server" href="http://www.myopenid.com/server">
    <link rel="openid.delegate" href="http://chrisroos.myopenid.com/">
    <title>Posts published in August 2006 - deferred until inspiration hits</title>
  </head>
  
  <body>
    
    <div id="doc3" class="yui-t4">
      <div id="hd">
        <h1><a class="blogTitle" href="/">deferred until inspiration hits</a></h1>
      </div>
      <div id="bd">
        <div id="yui-main">
          <div class="yui-b">
            <div class="yui-g">

              
                <h2>
                  <a href="/articles/2006/08/22/textmate-environment-and-ruby-again">Textmate environment and ruby (again)</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Tue, 22 Aug 2006 23:53:00">
                    Tue, 22 Aug 2006 23:53:00
                  </span>
                </p>

                <p>I&#8217;ve recently upgraded the version of ruby on my machine and came up against problems similar to <a href="http://blog.seagul.co.uk/articles/2006/07/28/textmate-and-env-ruby-no-such-file-or-directory">this</a>.  The problem previously was that <a href="http://www.macromates.com">textmate</a> wasn&#8217;t finding <a href="http://www.ruby-lang.org">ruby</a> at all.  This time, textmate was finding the wrong version of ruby.</p>


	<p>I found the following script useful in determining exactly which ruby binary textmate was using.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="comment">#!/usr/bin/env ruby</span>

<span class="ident">require</span> <span class="punct">'</span><span class="string">rbconfig</span><span class="punct">'</span>
<span class="ident">puts</span> <span class="constant">Config</span><span class="punct">::</span><span class="constant">CONFIG</span><span class="punct">['</span><span class="string">bindir</span><span class="punct">']</span></code></pre></div>

	<p>Simply paste that into a textmate document, select it and hit Ctrl-r.  The path of the ruby binary should print right there in the window.</p>


	<p>To see far more info than you&#8217;ll ever likely need, replace the line starting <code>puts</code> above, with the following..</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="constant">Config</span><span class="punct">::</span><span class="constant">CONFIG</span><span class="punct">.</span><span class="ident">sort</span><span class="punct">.</span><span class="ident">each</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">key</span><span class="punct">,</span> <span class="ident">value</span><span class="punct">|</span>
    <span class="ident">puts</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{key}</span> = <span class="expr">#{value}</span></span><span class="punct">&quot;</span>
<span class="keyword">end</span></code></pre></div>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/environment" rel="tag">environment</a>, 
                    
                      <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                    
                      <a href="/articles/tag/textmate" rel="tag">textmate</a>, 
                    
                  </p>
                
              
                <h2>
                  <a href="/articles/2006/08/22/rails-leaking-some-strings-in-development">Rails leaking some strings in development</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Tue, 22 Aug 2006 10:47:00">
                    Tue, 22 Aug 2006 10:47:00
                  </span>
                </p>

                <p>I spent some time this morning checking out <a href="http://scottstuff.net/blog/">Scott Laird&#8217;s</a> <a href="http://scottstuff.net/blog/articles/2006/08/17/memory-leak-profiling-with-rails">memory profiler</a> against a fresh rails app.</p>


	<p>I was suprised to see that around 110 strings were being leaked on each request.  I was incredibly surprised when I used the string_debug option (to the memory profiler) to generate logs of strings living in ObjectSpace.  There were strings appearing that I <em>knew</em> were not in my new rails app anywhere.</p>


	<p>After grepping my working directory for some of these strings (and not coming up with anything), <a href="http://blog.floehopper.org">James</a> suggested that the strings could be in my irb history.  Although it wasn&#8217;t immediately obvious how they were appearing, the strings were indeed in my history (just over 100 lines worth.)</p>


	<p>A little inspection and the culprit was found.  The <a href="http://api.rubyonrails.com/classes/Breakpoint.html">rails breakpoint library</a> requires irb, which loads the irb_history.</p>


	<p>In summary: the contents of irb_history are loaded into object space on each request made to your rails app, while in development.  These strings do not appear to get garbage collected.  The problem does not affect apps running in production as the breakpoint library is not loaded in that environment.</p>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/memoryleak" rel="tag">memoryleak</a>, 
                    
                      <a href="/articles/tag/rails" rel="tag">rails</a>, 
                    
                      <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                    
                  </p>
                
              
                <h2>
                  <a href="/articles/2006/08/22/feed-reading-feature-requests">Feed reading feature requests</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Tue, 22 Aug 2006 08:03:00">
                    Tue, 22 Aug 2006 08:03:00
                  </span>
                </p>

                <p>A bit of an unordered list of features I&#8217;d like to see in a feed reader.  It&#8217;s very possible these exist in some readers that I&#8217;m not aware of (I&#8217;ve moved from <a href="http://www.sharpreader.net/">desktop app on windows</a> through <a href="http://bloglines.com/">bloglines</a> and <a href="http://www.rojo.com">rojo</a> to <a href="http://www.feedshow.com">feedshow</a>).</p>


	<ul>
	<li>Comment from within the reader.  This would then automatically subscribe to a feed of the comments so that I could poll the updates.</li>
	</ul>


	<ul>
	<li>Notify me when feeds haven&#8217;t been accessible for a while.  Maybe the address has changed or the reader cannot interpret the feed correctly; either way, I&#8217;d like to know so that I can make an informed decision about what to do.</li>
	</ul>


	<ul>
	<li>When a page offers multiple feed formats, I don&#8217;t want to be asked what format to subscribe to.  The program should know the format it supports best and choose that.  As I type this, I&#8217;m thinking that this is more difficult if there is a choice between full and summary content.</li>
	</ul>


	<ul>
	<li>If an existing article is &#8216;refreshed&#8217; then diff it.  If it hasn&#8217;t changed then I don&#8217;t want to see it.  If it has changed, then highlight the changes for me.</li>
	</ul>


	<ul>
	<li>Show html in articles sensibly (rojo seemed to fail miserably on this front).</li>
	</ul>


	<ul>
	<li>Host a &#8216;live&#8217; (i.e. dynamically generated copy of my feeds in opml) &#8211; I can&#8217;t think of any reason to have to import/export these.</li>
	</ul>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/apps" rel="tag">apps</a>, 
                    
                      <a href="/articles/tag/feed" rel="tag">feed</a>, 
                    
                      <a href="/articles/tag/reading" rel="tag">reading</a>, 
                    
                  </p>
                
              
                <h2>
                  <a href="/articles/2006/08/21/i-hope-i-didnt-break-rubyforge">I hope I didn't break rubyforge...</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Mon, 21 Aug 2006 23:30:00">
                    Mon, 21 Aug 2006 23:30:00
                  </span>
                </p>

                <p>A couple of days ago I was playing around with <a href="http://search.cpan.org/~clkao/SVN-Mirror-0.68/lib/SVN/Mirror.pm"><span class="caps">SVN</span>::Mirror</a>, trying to remove some <a href="http://wiki.rubyonrails.org/rails/pages/Plugins">dependencies</a> on third party repositories not in our control.</p>


	<p>All was going well until I tried to mirror a <a href="http://rubyforge.org/projects/mocha/">project</a> hosted on rubyforge.  On initialising the mirror, I kept receiving the error &#8220;source url not under source root&#8221; from line 72 in Ra.pm.</p>


	<p>After some very careful debugging (yeah, like I know anything about perl &#8211; <code>print "1";</code> was about the extent of it) of that perl file; I noticed that the $source_root variable didn&#8217;t contain the double slash<sup><a href="#fn1">1</a></sup>.  This causes a problem for the line <code>if substr($path, 0, length($source_root), '') ne $source_root;</code> as at this point, $path does contain the double slash.</p>


	<p>The value of $source_root is returned from a call to RA-&gt;get_repos_root (Subversion Repository Access code).  So; it would seem that the url was being normalised somewhere in the bowels of <a href="http://subversion.tigris.org">Subversion</a>.</p>


	<p>This was kinda confirmed by testing the svn client (which uses the code in the RA module just like <span class="caps">SVN</span>::Mirror) with urls containing additional slashes.  The url was always resolved and svn info would always show the normalised variant.  It was additionally(ish) tested by using the <a href="http://www.ruby-lang.org">Ruby</a> <a href="http://svn.collab.net/viewvc/svn/trunk/subversion/bindings/swig/ruby/">bindings</a> (which, as an aside, contain just about the most difficult to read Ruby code I&#8217;ve ever come across!)</p>


	<p>I would love to have followed the actual subversion c code to find the normalisation routine but I&#8217;m sadly not clever enough; so my findings had to suffice.</p>


	<p>Anyhoo, the outcome of the story is that I emailed Tom Copeland of rubyforge fame to ask about the deal with the double slashes.  Turns out that it was probably just a <a href="http://gforge.org/">gforge</a> default thing and Tom went ahead and promptly changed it.  I suddenly got very nervous that lots of arms would be thrown up with cries of &#8220;Who broke rubyforge?&#8221;, but so far it would appears to be ok.  Phew.</p>


	<p id="fn1"><sup>1</sup> Not sure if anyone else had really noticed but the svn repositories on rubyforge used to contain a double slash between the domain and var path (i.e. rubyforge.org//var).</p>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/perl" rel="tag">perl</a>, 
                    
                      <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                    
                      <a href="/articles/tag/rubyforge" rel="tag">rubyforge</a>, 
                    
                      <a href="/articles/tag/svm" rel="tag">svm</a>, 
                    
                      <a href="/articles/tag/svn" rel="tag">svn</a>, 
                    
                  </p>
                
              
                <h2>
                  <a href="/articles/2006/08/17/i-guess-thats-one-way-to-do-it">I guess that's one way to do it...</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Thu, 17 Aug 2006 08:08:00">
                    Thu, 17 Aug 2006 08:08:00
                  </span>
                </p>

                <p>We&#8217;re not <em>quite</em> at this stage yet&#8230;</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="keyword">class </span><span class="class">ActiveRecord::ConnectionAdapters::MysqlAdapter</span>
  <span class="keyword">alias</span> <span class="symbol">:execute_before_test_hijack</span> <span class="symbol">:execute</span>
  <span class="keyword">def </span><span class="method">execute</span><span class="punct">(*</span><span class="ident">args</span><span class="punct">)</span>
    <span class="keyword">unless</span> <span class="ident">args</span><span class="punct">.</span><span class="ident">first</span> <span class="punct">=~</span> <span class="punct">/</span><span class="regex">^SHOW FIELDS FROM</span><span class="punct">/</span> <span class="punct">||</span> <span class="punct">%w[</span><span class="string">BEGIN COMMIT ROLLBACK END</span><span class="punct">].</span><span class="ident">include?</span><span class="punct">(</span><span class="ident">args</span><span class="punct">.</span><span class="ident">first</span><span class="punct">)</span>
      <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">You know you're not allowed to use the database in your tests...</span><span class="punct">&quot;</span> <span class="comment"># We could be more gentle with a warn</span>
    <span class="keyword">end</span>
    <span class="ident">execute_before_unit_test_hijack</span><span class="punct">(*</span><span class="ident">args</span><span class="punct">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span></code></pre></div>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/database" rel="tag">database</a>, 
                    
                      <a href="/articles/tag/rails" rel="tag">rails</a>, 
                    
                      <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                    
                      <a href="/articles/tag/testing" rel="tag">testing</a>, 
                    
                  </p>
                
              
                <h2>
                  <a href="/articles/2006/08/14/tickling-link_to-into-submission">Tickling link_to into submission</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Mon, 14 Aug 2006 23:10:00">
                    Mon, 14 Aug 2006 23:10:00
                  </span>
                </p>

                <p>What a crappy title.  Ho hum.</p>


	<p>This bit explains the itch I had.  Skip over it if you like.</p>


	<p>I recently finished re-structuring some of the code at <a href="http://www.reevoo.com">work</a>, in which I namespaced all of the admin type controllers.  At the same time, I attempted to split some of the larger, confused (about their responsibilities) controllers into smaller chunks.  This all seems to have worked quite well, but we&#8217;ve ended up with some naff (I haven&#8217;t used that word in ages) action names.</p>


	<p>I like, where possible, to follow the scaffold naming convention (list, show, new, create, edit, update and destroy); and so went ahead and started changing things.  I was writing my tests like mum always said I should<sup><a href="#fn1">1</a></sup> when I realised that there was a bit missing (uh oh).  You see, I was ensuring that my controllers responded to certain actions; and I was also ensuring that my views had links to certain controllers and actions.  The missing link was a check as to whether the links in my views went to valid controller actions.  I could, for example, have been testing for a link to /foo/edit in my view but for an edit_foo action in my foo_controller test.  Both tests would pass, but the application would still be broken.  Not cool.  We do actually have <a href="http://openqa.org/selenium">something</a> in place to perform these tests but I&#8217;m still a bit scared of selenium and don&#8217;t use it as much as I should.</p>


	<p>Anyway, i started thinking about bending the <a href="http://api.rubyonrails.com/classes/ActionView/Helpers/UrlHelper.html#M000378">link_to</a> helper to my will.  I figured that the little fella was a good candidate to not only give me a perfectly formed chunk of html goodness; but to also tell me whether the said chunk of html goodness was actually going to work (i.e. whether my app responded to the generated url).  Cool idea huh.</p>


	<p>I&#8217;m getting tired and a little bored now so I&#8217;ll wrap this post up.  I&#8217;ve created a <a href="http://dev.seagul.co.uk/repository/browse/plugins/action_view_helper_url_helper">plugin</a> (svn co svn://dev.seagul.co.uk/plugins/action_view_helper_url_helper) that replaces the link_to method to add a class attribute (invalid_href_target or valid_href_target) to the generated anchor tag.  You could then use the assert_no_broken_links assertion to ensure there are no anchors with a class of invalid_href_target in your views; and/or you could style it (see resource/style.css as an example) so that you can see any broken links at a glance whilst in development (as shown in the image below).</p>


	<p><img src="http://farm1.static.flickr.com/192/460075342_987c127e66_o.jpg" alt="" /></p>


	<p>The code is pretty poor/naive, works with rails 1.0.0 (hence my trying to <a href="http://blog.seagul.co.uk/articles/2006/08/14/create-rails-projects-using-a-specific-rails-gem-version">set-up a rails 1.0.0 app</a> earlier), doesn&#8217;t work with rails 1.1.6 (not sure about versions in between) and may or may not work for you.  I kinda think it&#8217;s a good idea but there&#8217;s every chance that a) it&#8217;s not or b) there&#8217;s already a simple solution to this problem.</p>


	<p>Let me know how you get on if you decide to risk the health of your project by trying this plugin.</p>


	<p id="fn1"><sup>1</sup> She didn&#8217;t say that.</p>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/plugin" rel="tag">plugin</a>, 
                    
                      <a href="/articles/tag/rails" rel="tag">rails</a>, 
                    
                      <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                    
                  </p>
                
              
                <h2>
                  <a href="/articles/2006/08/14/create-rails-projects-using-a-specific-rails-gem-version">Create rails projects using a specific rails gem version</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Mon, 14 Aug 2006 22:06:00">
                    Mon, 14 Aug 2006 22:06:00
                  </span>
                </p>

                <p>I just found this when trying to create a rails project using rails 1.0.0 (having both 1.0.0 and 1.1.6 installed as gems).</p>


	<p>If the first argument to the rails command is a valid (i.e. installed) version number and surrounded by underscores then that version of the gem is used to create the rails application structure.</p>


	<p>So (with 1.0.0 and 1.1.6 gems installed)..</p>


<pre>
$ rails _1.0.0_ my-rails-proj
#-&gt; uses rails version 1

$ rails my-rails-proj
#-&gt; uses latest rails version (1.1.6)
</pre>

	<p>Although you can normally place the rails libraries into the vendor directory of a given rails app (to use that specific rails version); I had problems when placing rails 1.0.0 into a rails 1.1.6 generated app.  An error is encountered when trying to boot webrick..</p>


<code>
./script/../config/../vendor/rails/railties/lib/initializer.rb:256:in `send': undefined method `cache_template_extensions=' for ActionView::Base:Class (NoMethodError)
</code>

	<p>By passing the version argument to the rails command and then placing rails 1.0.0 into the vendor directory, everything works as expected.</p>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/rails" rel="tag">rails</a>, 
                    
                      <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                    
                  </p>
                
              
                <h2>
                  <a href="/articles/2006/08/05/new-rails-weblob">New rails weblob</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Sat, 05 Aug 2006 00:47:00">
                    Sat, 05 Aug 2006 00:47:00
                  </span>
                </p>

                <p><a href="http://railsblob.blogspot.com/">he he he</a></p>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/blog" rel="tag">blog</a>, 
                    
                      <a href="/articles/tag/rails" rel="tag">rails</a>, 
                    
                  </p>
                
              
                <h2>
                  <a href="/articles/2006/08/02/helpful-error-messages-when-active-record-objects-fail-validation-in-tests">Helpful error messages when active record objects fail validation (in tests)</a>
                </h2>
                <p class="postedOn">
                  Posted by Chris Roos
                  <span class="typo_date" title="Wed, 02 Aug 2006 13:47:00">
                    Wed, 02 Aug 2006 13:47:00
                  </span>
                </p>

                <p>I <a href="http://blog.seagul.co.uk/articles/2006/06/21/more-helpful-messages-for-active-record-validation-errors-in-rails-testing">posted</a> a while back about displaying the reasons for an active record model failing validation.</p>


	<p>I knew the code was hacky and nasty but didn&#8217;t realise quite how bad until I noticed how <a href="http://dev.rubyonrails.org/browser/tags/rel_1-1-0/activerecord/lib/active_record/validations.rb">simply</a>  (1 line) the same thing was implemented in <a href="http://weblog.rubyonrails.com/2006/3/28/rails-1-1-rjs-active-record-respond_to-integration-tests-and-500-other-things">Rails 1.1</a> (and above).</p>


	<p>Although it&#8217;s only useful for people still on Rails 1.0, I made a quick plugin that backports this change.  I don&#8217;t really want to put it in my subversion repository, so have just pasted the necessary code below.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="comment"># File init.rb</span>
<span class="ident">require</span> <span class="constant">File</span><span class="punct">.</span><span class="ident">dirname</span><span class="punct">(</span><span class="constant">__FILE__</span><span class="punct">)</span> <span class="punct">+</span> <span class="punct">'</span><span class="string">/lib/record_invalid</span><span class="punct">'</span></code></pre></div>

<div class="typocode"><pre><code class="typocode_ruby"><span class="comment"># File record_invalid.rb</span>
<span class="keyword">module </span><span class="module">ActiveRecord</span>

  <span class="keyword">class </span><span class="class">RecordInvalid</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecordError</span>
    <span class="keyword">def </span><span class="method">initialize</span><span class="punct">(</span><span class="ident">record</span><span class="punct">)</span>
      <span class="attribute">@record</span> <span class="punct">=</span> <span class="ident">record</span>
      <span class="keyword">super</span><span class="punct">(&quot;</span><span class="string">Validation failed: <span class="expr">#{@record.errors.full_messages.join(&quot;, &quot;)}</span></span><span class="punct">&quot;)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>

<span class="keyword">end</span></code></pre></div>

	<p>To create a plugin from this, create the following structure in your rails_app/vendor/plugins directory.</p>


<pre>
active_record_validation_error/
|
|--init.rb (copy contents of code above)
|
|--lib/
   |
   |--record_invalid.rb (copy content of code above)
</pre>

                
                  <p>
                    Tags 
                    
                      <a href="/articles/tag/activerecord" rel="tag">activerecord</a>, 
                    
                      <a href="/articles/tag/plugin" rel="tag">plugin</a>, 
                    
                      <a href="/articles/tag/rails" rel="tag">rails</a>, 
                    
                      <a href="/articles/tag/validation" rel="tag">validation</a>, 
                    
                  </p>
                
              

            </div>
          </div>
        </div>
        <div class="yui-b">
          <img class="avatar" src="/images/me.jpg" width="170px" height="111px" alt="Me">
          
          <ul class="navigation">
            <li>
              <a href="/contents">contents</a>
            </li>
            <li>
              <a href="http://flickr.com/photos/chrisjroos">flickr</a>
            </li>
          </ul>
          
          <div id="twitter_div">
            <h3><a href="http://twitter.com/chrisroos">twitter</a></h3>
            <ul id="twitter_update_list"></ul>
          </div>
          
          <div id="deliciousContainer">
            <h3><a href="http://del.icio.us/chrisjroos">del.icio.us</a></h3>
          </div>
        </div>
      </div>
    </div>
    <div id="ft">
      <!-- Footer -->
    </div>
    
    <script type="text/javascript" src="http://twitter.com/javascripts/blogger.js"></script>
    <script type="text/javascript" src="http://twitter.com/statuses/user_timeline/chrisroos.json?callback=twitterCallback2&amp;count=5"></script>
    
    <script type="text/javascript" src="http://del.icio.us/feeds/json/chrisjroos?count=5"></script>
    <script type="text/javascript" src="/javascripts/delicious.js"></script>
  
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      if (typeof(_gat) != 'undefined') {
        var pageTracker = _gat._getTracker("UA-160238-1");
        pageTracker._initData();
        pageTracker._trackPageview();
      }
    </script>
  </body>

</html>
