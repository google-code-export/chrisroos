<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>

  <head>
    <meta name="microid" content="ff511e16d7108be450fccd6f4611cf8d1d5416d1" >
    <meta http-equiv="content-type" content="text/html; charset=utf-8" >
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/DeferredUntilInspirationHits" >
    <link rel="stylesheet" href="/stylesheets/yui-reset-fonts-grids.css" type="text/css" media="all">
    <link rel="stylesheet" href="/stylesheets/blog.css" type="text/css" media="all" charset="utf-8">
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="all" charset="utf-8">
    <link rel="stylesheet" href="/stylesheets/print.css" type="text/css" media="print" charset="utf-8">
    <link rel="openid.server" href="http://www.myopenid.com/server">
    <link rel="openid.delegate" href="http://chrisroos.myopenid.com/">
    <title>Fun with mod_rewrite (and its special variables REQUEST_URI, IS_SUBREQ and THE_REQUEST) - deferred until inspiration hits</title>
  </head>

  <body>
    
    <div id="doc3" class="yui-t4">
      <div id="hd">
        <h1><a class="blogTitle" href="/">deferred until inspiration hits</a></h1>
      </div>
      <div id="bd">
        <div id="yui-main">
          <div class="yui-b">
            <div class="yui-g">

              <h2>Fun with mod_rewrite (and its special variables REQUEST_URI, IS_SUBREQ and THE_REQUEST)</h2>
            
              <p class="postedOn">
                Posted by Chris Roos
                <span title="Mon, 14 Jan 2008 10:14:00">
                  Mon, 14 Jan 2008 10:14:00
                </span>
              </p>
          
              <p>I wasted a few hours of my life, over the weekend, playing with <a href="http://httpd.apache.org/docs/1.3/mod/mod_rewrite.html">mod_rewrite</a>.  I had, what I thought to be, a fairly simple problem to solve: I wanted requests for index.html within any subdirectory of my site to be <a href="http://en.wikipedia.org/wiki/URL_redirection">redirected</a> to the root of that subdirectory.  So, a request for example.com/subdir/index.html would be (301) redirected to example.com/subdir/.</p>


	<p>I thought I could do this without using <a href="http://httpd.apache.org/docs/1.3/mod/mod_rewrite.html#RewriteCond">RewriteCond</a>.  I tried something like this.</p>


<div class="typocode"><pre><code class="typocode_default">RewriteRule ^(.*)index\.html$ $1 [R=301]</code></pre></div>

	<p>I would expect this to match requests for URLs that end with index.html and redirect them to the <span class="caps">URL</span> minus index.html.  Although this correctly redirected /subdir/index.html to /subdir/ it would also attempt to redirect /subdir/ to /subdir/ resulting in an infinite loop.  It took me a very long time to work out, what I believe, is going on.  If I understand correctly, <a href="http://httpd.apache.org/">apache</a> will send every request (i.e. not just the request you issue from the browser) through mod_rewrite.  When we request /subdir/, apache will try, and fail, to match that <span class="caps">URL</span> with our regex (/subdir/ doesn&#8217;t end with index.html).  Internally, apache then &#8216;requests&#8217; index.html (since index.html is the <a href="http://httpd.apache.org/docs/1.3/mod/mod_dir.html#directoryindex">DirectoryIndex</a>).  This request matches our regex which results in apache sending the 301 redirect and us ending up with an infinite loop.  If I mis-understand what&#8217;s going on please feel free to correct me.</p>


	<p>Based on this assumption, I figured I&#8217;d need to use RewriteCond to somehow ignore the internal request for index.html.  I initially added a condition that checked for the <span class="caps">REQUEST</span>_URI ending in index.html (<code>RewriteCond %{REQUEST_URI} index\.html$</code>).  This suffered the same problem as my initial attempt.  A little more reading led me to the IS_SUBREQ special variable.  I thought this might allow me to ignore the &#8216;internal request&#8217; for index.html (<code>RewriteCond %{IS_SUBREQ} false</code>) but I couldn&#8217;t get it to have any effect.</p>


	<p>In searching for answers to this problem I kept seeing <span class="caps">THE</span>_REQUEST special variable used in the solution, although never an explanation as to why it&#8217;s used (specifically in preference to <span class="caps">REQUEST</span>_URI).  I ended up using <span class="caps">THE</span>_REQUEST in my solution (not technically my solution as I stole it from a site that I failed to bookmark) and it seems to work OK.</p>


<div class="typocode"><pre><code class="typocode_default">RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /.*index\.html\ HTTP/
RewriteRule ^(.*)index\.html$ $1 [R=301,L]</code></pre></div>

	<p>I&#8217;m guessing that this is because <span class="caps">THE</span>_REQUEST contains the full details (the stuff that appears in the log file) of the request from the client (browser) and will therefore be empty for any &#8216;internal requests&#8217;.  Anyone know if my assumptions are correct?</p>
        
              
                <p>
                  Tags 
                  
                    <a href="/articles/tag/apache" rel="tag">apache</a>, 
                  
                    <a href="/articles/tag/mod_rewrite" rel="tag">mod_rewrite</a>, 
                  
                    <a href="/articles/tag/url" rel="tag">url</a>, 
                  
                </p>
              
          
              <div id="disqus_thread"></div>
              <script type="text/javascript" src="http://disqus.com/forums/deferred-until-inspiration-hits/embed.js"></script>
              <noscript>
                <p><a href="http://deferred-until-inspiration-hits.disqus.com/?url=ref">View the forum thread.</a></p>
              </noscript>

              
                <h2>Legacy Comments</h2>
                <ol class="comments">
                  
                  <li>
                    <p class="postedOn">
                      <strong>
                        
                          <a href="http://thanetstar.com/">Matt B</a>
                        
                      </strong>
                      said on Wed, 16 Jan 2008 17:55:30:
                    </p>
                    <p>The thing about mod rewrite is that it is voodoo, damn cool voodoo but voodoo nevertheless (some one more impressive than me said that ages ago but I&#8217;m to lazy to look up the actual quote).</p>


	<p>I had a similar situation when I moved a wiki from a sub directory to a sub domain.  The sub domain required that the folder of the SD be in the ht root.  Common cPanel hackishness.  So all requests for lordmatt.co.uk/wiki and wiki.lordmatt.co.uk were exactly the same.</p>


	<p>I came up with:</p>


<pre>RewriteCond %{HTTP_HOST} !^wiki\.lordmatt\.co\.uk(.*)$ [NC]
RewriteCond %{REQUEST_URI} ^/wiki/ [NC]
RewriteRule ^wiki(.*)$  http://wiki.lordmatt.co.uk$1 [R=301,NC,L]</pre>

	<p>The problem I had was similar in that if I redirected for the &#8220;wrong&#8221; urls then the internal requests looped forever.  The result is http code 500 &#8211; internal server error.</p>


	<p>As you can gather there is more than one way to get something to work.  As with all voodoo that it works is important and a congratulations is awarded to anyone able to brew up a solution to a problem.</p>
                  </li>
                  
                </ol>
              
              
              

            </div>
          </div>
        </div>
        <div class="yui-b">
          <img class="avatar" src="/images/me.jpg" width="170px" height="111px" alt="Me">
          
          <ul class="navigation">
            <li>
              <a href="/contents">contents</a>
            </li>
            <li>
              <a href="http://flickr.com/photos/chrisjroos">flickr</a>
            </li>
          </ul>
          
          <div id="twitter_div">
            <h3><a href="http://twitter.com/chrisroos">twitter</a></h3>
            <ul id="twitter_update_list"></ul>
          </div>
          
          <div id="deliciousContainer">
            <h3><a href="http://del.icio.us/chrisjroos">del.icio.us</a></h3>
          </div>
        </div>
      </div>
    </div>
    <div id="ft">
      <!-- Footer -->
    </div>
    
    <script type="text/javascript" src="http://twitter.com/javascripts/blogger.js"></script>
    <script type="text/javascript" src="http://twitter.com/statuses/user_timeline/chrisroos.json?callback=twitterCallback2&amp;count=5"></script>
    
    <script type="text/javascript" src="http://del.icio.us/feeds/json/chrisjroos?count=5"></script>
    <script type="text/javascript" src="/javascripts/delicious.js"></script>
  
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      if (typeof(_gat) != 'undefined') {
        var pageTracker = _gat._getTracker("UA-160238-1");
        pageTracker._initData();
        pageTracker._trackPageview();
      }
    </script>
  </body>

</html>
