<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

  <head>
    <!--#include virtual="/includes/_head.html"-->
    <title>Using in memory Active Record objects with associations for testing - deferred until inspiration hits</title>
  </head>

  <body>
    
    <div id="doc3" class="yui-t4">
      <div id="hd">
        <div class="header">
          <!--#include virtual="/includes/_header.html"-->
        </div>
        <div class="navigation">
          
            <span class="previousPost">
              &larr; (older)
              <a class="previousPost" href="/blog/2006-07-12-ruby-hashes-with-default-values" title="Ruby hashes with default values">
                
                Ruby hashes with default values
              </a> 
            </span>
          
          
            <span class="nextPost">
              <a class="nextPost" href="/blog/2006-07-14-textmate-command-to-display-active-record-column-attributes" title="Textmate command to display Active Record column attributes">
                
                Textmate command to display Active Record column attribu...
              </a> (newer) &rarr;
            </span>
          
        </div>
      </div>
      <div id="bd">
        <div id="yui-main">
          <div class="yui-b">
            <div class="yui-g">
              
              <h1>Using in memory Active Record objects with associations for testing</h1>
            
              <p class="postedOn">
                Posted by Chris Roos
                <span title="Wed, 12 Jul 2006 01:23:00">
                  Wed, 12 Jul 2006 01:23:00
                </span>
              </p>
          
              <p>Hitting the database in testing is bad.</p>


	<p>Something that I&#8217;ve found relatively useful at <a href="http://www.reevoo.com">work</a> is to use real <a href="http://api.rubyonrails.com/classes/ActiveRecord/Base.html">Active Record</a> objects without any persistence (basically use AR#new and not AR#save[!] or AR#create[!]).  When using standard techniques to create the association objects in memory you only get one side of the association at a time.  Consider the following.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="keyword">class </span><span class="class">Person</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span>
  <span class="ident">has_many</span> <span class="symbol">:addresses</span>
<span class="keyword">end</span>
<span class="keyword">class </span><span class="class">Address</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span>
  <span class="ident">belongs_to</span> <span class="symbol">:person</span>
<span class="keyword">end</span>

<span class="comment"># One sided relationship with parent getting access to child</span>
<span class="ident">chris</span> <span class="punct">=</span> <span class="constant">Person</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">home</span> <span class="punct">=</span> <span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span><span class="punct">.</span><span class="ident">build</span>

<span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span><span class="punct">.</span><span class="ident">first</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;home&gt;</span>
<span class="ident">home</span><span class="punct">.</span><span class="ident">person</span>
<span class="punct">=&gt;</span> <span class="constant">nil</span>

<span class="comment"># One sided relationship with child getting access to parent</span>
<span class="ident">home</span> <span class="punct">=</span> <span class="constant">Address</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">chris</span> <span class="punct">=</span> <span class="ident">home</span><span class="punct">.</span><span class="ident">build_person</span>

<span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span>
<span class="punct">=&gt;</span> <span class="punct">[]</span>
<span class="ident">home</span><span class="punct">.</span><span class="ident">person</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;chris&gt;</span>

<span class="comment"># The example above that creates the address first could also have been written as.</span>
<span class="comment"># chris = Person.new</span>
<span class="comment"># home = Address.new(:person =&gt; chris)</span></code></pre></div>

	<p>You can see that in each case, only one side of the relationship has access to the other.  If we were persisting the objects then the relationship would be two way via a database lookup.  We can get a two way relationship in memory; although it has a certain duplication smell about it.  Assuming the same models as above, we can amend the above examples like so.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="comment"># First example</span>
<span class="ident">chris</span> <span class="punct">=</span> <span class="constant">Person</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">home</span> <span class="punct">=</span> <span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span><span class="punct">.</span><span class="ident">build</span><span class="punct">(</span><span class="symbol">:person</span> <span class="punct">=&gt;</span> <span class="ident">chris</span><span class="punct">)</span>

<span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span><span class="punct">.</span><span class="ident">first</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;home&gt;</span>
<span class="ident">home</span><span class="punct">.</span><span class="ident">person</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;chris&gt;</span>

<span class="comment"># Second example</span>
<span class="ident">home</span> <span class="punct">=</span> <span class="constant">Address</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">chris</span> <span class="punct">=</span> <span class="ident">home</span><span class="punct">.</span><span class="ident">build_person</span><span class="punct">(</span><span class="symbol">:addresses</span> <span class="punct">=&gt;</span> <span class="punct">[</span><span class="ident">home</span><span class="punct">])</span>

<span class="ident">home</span><span class="punct">.</span><span class="ident">person</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;chris&gt;</span>
<span class="ident">chris</span><span class="punct">.</span><span class="ident">addresses</span><span class="punct">.</span><span class="ident">first</span>
<span class="punct">=&gt;</span> <span class="comment">#&lt;home&gt;</span></code></pre></div>

	<p>I&#8217;ve occasionally used this in place of stubbing methods but am still not 100% convinced of the definite benefits one way or another.  I do have some definite disadvantages of stubbing methods (nothing exciting, they&#8217;ve almost certainly been noted by many others in the past) which I&#8217;ll note down at a later date.</p>
        
              <div id="disqus_thread"></div>
              <script type="text/javascript" src="http://disqus.com/forums/deferred-until-inspiration-hits/embed.js"></script>
              <noscript>
                <p><a href="http://deferred-until-inspiration-hits.disqus.com/?url=ref">View the forum thread.</a></p>
              </noscript>

              

            </div>
          </div>
        </div>
        <div class="yui-b">
          <!--#include virtual="/includes/_navigation.html"-->
        </div>
      </div>
    </div>
    <div id="ft">
      <!-- Footer -->
    </div>
    
    <!--#include virtual="/includes/_twitter.html" -->
    <!--#include virtual="/includes/_delicious.html" -->
    <!--#include virtual="/includes/_google_analytics.html" -->
  </body>

</html>
