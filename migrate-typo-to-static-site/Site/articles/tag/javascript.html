<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta name="microid" content="ff511e16d7108be450fccd6f4611cf8d1d5416d1" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/DeferredUntilInspirationHits" />
    <link rel="stylesheet" href="/stylesheets/azure.css" media="all" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/print.css" media="print" type="text/css" />
    <link rel="openid.server" href="http://www.myopenid.com/server"/>
    <link rel="openid.delegate" href="http://chrisroos.myopenid.com/"/>
    <title>Posts tagged javascript - deferred until inspiration hits</title>
  </head>

  <body>
  
    <div id="container" class="clearfix">
    
      <div id="header">
        <div id="logo">
          <h1 id="sitename"><a href="/">deferred until inspiration hits</a></h1>
        </div>
      </div>

      <div id="search">
      </div>

      <div id="content" class="clearfix">

        <div id="main">

          
            <div class="post">
              <h2>
                <a href="/articles/2007/12/14/cross-browser-well-ie-6-firefox-2-and-safari-3-bookmarklet-script">Cross browser (well, IE 6, Firefox 2 and Safari 3) bookmarklet script</a>
              </h2>
              <p class="auth">
                Posted by Chris Roos
                <span class="typo_date" title="Fri, 14 Dec 2007 21:27:00">
                  Fri, 14 Dec 2007 21:27:00
                </span>
              </p>
          
              <p>I <a href="http://blog.seagul.co.uk/articles/2007/12/14/bookmarklet-favelet-limits-in-internet-explorer-6-and-7">mentioned</a> that I&#8217;d been playing with bookmarklets in Internet Explorer 6 (among other, proper, browsers).</p>


	<p>I thought it might be useful to paste the script that bootstraps the bookmarklet.  The concept is that we use the bookmarklet javascript to insert a script tag into the page that links to the full javascript file containing the function(s) that we wish to execute.  I know this has been documented elsewhere and I&#8217;ve probably missed some important stuff out but it may prove useful to someone.</p>


	<h3>The commented, un-compressed, version</h3>


<div class="typocode"><pre><code class="typocode_javascript">if (typeof(rvmBM) == 'undefined') { // Best to name rvmBM to something unlikely to clash with pre-defined variables
  var s = document.createElement('script'); // Use of s versus script saves some precious space
  s.type = 'text/javascript';
  s.src = 'http://example.com/my-external-bookmarklet.js'; // The location of your bookmarklet javascript that does all the work
  void(rvmBM = true); // Prevent the bookmarklet javascript from being loaded multiple times by setting this flag
  void(document.body.appendChild(s)); // Place the script tag in the body of the document
  // If we don't use void() above then we end up writing either 'true' or some junk to the screen in Internet Explorer (only)
};
function addRvm() { // A wrapper function around the actual function we want to call
  if (typeof(addReevooMark) == 'function') { // We want to make sure our bookmarklet function is defined (there's some delay in it becoming available in Firefox.  It's defined immediately in Internet Explorer.)
    addReevooMark();
  } else {
    void(setTimeout(addRvm, 100)); // If our function isn't ready yet we'll just hang on 1/10th of a second and try again
  };
};
addRvm(); // Ask our wrapper function to call the actual bookmarklet function</code></pre></div>

	<h3>The compressed version</h3>


<div class="typocode"><pre><code class="typocode_javascript">javascript:if(typeof(rvmBM)=='undefined'){var s=document.createElement('script');s.type='text/javascript';s.src='http://example.com/my-external-bookmarklet.js';void(rvmBM=true);void(document.body.appendChild(s));};function addRvm(){if(typeof(addReevooMark)=='function'){addReevooMark();}else{void(setTimeout(addRvm,100));};};addRvm();</code></pre></div>
            </div>
        
            <p class="meta">
              
                Tags 
                
                  <a href="/articles/tag/bookmarklet" rel="tag">bookmarklet</a>, 
                
                  <a href="/articles/tag/browser" rel="tag">browser</a>, 
                
                  <a href="/articles/tag/explorer" rel="tag">explorer</a>, 
                
                  <a href="/articles/tag/firefox" rel="tag">firefox</a>, 
                
                  <a href="/articles/tag/internet" rel="tag">internet</a>, 
                
                  <a href="/articles/tag/internet-explorer" rel="tag">internet-explorer</a>, 
                
                  <a href="/articles/tag/javascript" rel="tag">javascript</a>, 
                
                  <a href="/articles/tag/safari" rel="tag">safari</a>, 
                
              
            </p>
          
            <div class="post">
              <h2>
                <a href="/articles/2007/12/14/bookmarklet-favelet-limits-in-internet-explorer-6-and-7">Bookmarklet (Favelet) limits in Internet Explorer 6 (and 7?)</a>
              </h2>
              <p class="auth">
                Posted by Chris Roos
                <span class="typo_date" title="Fri, 14 Dec 2007 08:46:00">
                  Fri, 14 Dec 2007 08:46:00
                </span>
              </p>
          
              <p>I wasted quite a bit of time over the last couple of days trying to get a <a href="http://en.wikipedia.org/wiki/Bookmarklet">bookmarklet</a> (or favelet) working in Internet Explorer 6.  It worked perfectly in Firefox and Safari but wasn&#8217;t doing anything at all in IE.  Through lots of trial and error, I came to the conclusion that it was because of the length of the bookmarklet: it seems that Microsoft <a href="http://www.squarefree.com/2005/01/12/internet-explorer-drops-support-for-bookmarklets/">reduced the maximum length of a bookmarklet in <span class="caps">IE 6</span></a></p>


	<p>Although my original bookmarklet wasn&#8217;t all that long, I had it spread over multiple lines for readability.  The fix in my case was to remove all the spaces and place the bookmarklet on one line.</p>


	<p>I started to think that it might be nice to have a bookmarklet <a href="http://www.rubyonrails.com">rails</a> helper.  The bookmarklet helper would allow you to format your javascript for readability but shorten it all in the resulting html (it could even warn if the bookmarklet is too long for IE).  I couldn&#8217;t find anything similar, and I probably won&#8217;t get around to doing it myself, but I did decide to investigate the limit in IE (which could form the basis of such a helper).</p>


	<p>I used the html page below to test the limits of Internet Explorer.  This is the longest bookmarklet that I could get to work: one more character (a 2 on the end of those numbers, for example) and the bookmarklet won&#8217;t work (it still works if you click the link in the page &#8211; it only fails when used as an actual bookmarklet).</p>


<div class="typocode"><pre><code class="typocode_default">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot;&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;a href=&quot;javascript:
      var msg = 'hello world, this is my message.  i\'m trying to see how long i can be until internet explorer blows up in my face.';
      var msg = msg + '\n';
      var msg = msg + 'this is the second line of my long message';
      var msg = msg + '\n';
      var msg = msg + '12345679012345678901';
      alert(msg);&quot;&gt;bookmarklet&lt;/a&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre></div>

	<p>I noticed that, once added to Internet Explorer, the bookmarklet appeared to be <a href="http://www.blooberry.com/indexdot/html/topics/urlencoding.htm"><span class="caps">URL</span> encoded</a> (my assumption was based on the conversion of spaces to %20.)</p>


	<p><a href="http://www.flickr.com/photos/chrisjroos/2109757023/"><img src="http://farm3.static.flickr.com/2321/2109757023_0f69015c44.jpg" alt="" /></a></p>


	<p>I tried to replicate this encoded string in <a href="http://www.ruby-lang.org">ruby</a> but failed:  A simple <span class="caps">URI</span>.escape in ruby was escaping too much.  Inspecting the bookmarklet again seemed to suggest that the only encoding performed is to remove newlines and convert spaces to %20.  Replicating this in irb gave me the same string that Internet Explorer had in its favourites.</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="ident">irb</span><span class="punct">)</span> <span class="ident">str</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">javascript:
  var msg = 'hello world, this is my message.  i<span class="escape">\'</span>m trying to see how long i can be until internet explorer blows up in my face.';
  var msg = msg + '<span class="escape">\n</span>';
  var msg = msg + 'this is the second line of my long message';
  var msg = msg + '<span class="escape">\n</span>';
  var msg = msg + '12345679012345678901';
  alert(msg);</span><span class="punct">&quot;</span>
<span class="ident">irb</span><span class="punct">)</span> <span class="ident">p</span> <span class="ident">str</span><span class="punct">.</span><span class="ident">gsub</span><span class="punct">(&quot;</span><span class="string">'<span class="escape">\n</span>'</span><span class="punct">&quot;,</span> <span class="punct">&quot;</span><span class="string">'--NEW-LINE--'</span><span class="punct">&quot;).</span><span class="ident">gsub</span><span class="punct">(&quot;</span><span class="string"><span class="escape">\n</span></span><span class="punct">&quot;,</span> <span class="punct">'</span><span class="string"></span><span class="punct">').</span><span class="ident">gsub</span><span class="punct">(&quot;</span><span class="string">'--NEW-LINE--'</span><span class="punct">&quot;,</span> <span class="punct">&quot;</span><span class="string">'<span class="escape">\n</span>'</span><span class="punct">&quot;).</span><span class="ident">gsub</span><span class="punct">('</span><span class="string"> </span><span class="punct">',</span> <span class="punct">&quot;</span><span class="string">%20</span><span class="punct">&quot;).</span><span class="ident">length</span>
<span class="punct">=&gt;</span> <span class="number">505</span></code></pre></div>

	<p>Everything I&#8217;d read about these bookmarklets in Internet Explorer suggested that the limit was 508 characters: the length of the bookmarklet above (once encoded) is only 505 characters.  Adding one more character makes it fail as a bookmarklet.  Hmm, maybe I&#8217;m doing something dumb?</p>


	<p>I&#8217;ve cheated a bit in the &#8216;encoding&#8217; above.  IE removes all newlines (I wonder if this happens in the <span class="caps">DOM</span> or just when you add it as a favourite?) so that the bookmarklet appears on one line.  I needed to do the same but also needed those newlines in the msg to remain (hence the <span class="caps">NEW</span>-LINE replacement stuff).  This is a very naive imlpementation: if you have &#8217;\n\n&#8217;, for example, then it breaks.  The &#8216;encoding&#8217; would need to be a little more intelligent in an actual helper (but only if you wanted to report on the size of the bookmarklet).</p>


	<p>I couldn&#8217;t find any reference to source of this 508 character limit in Internet Explorer: all the blog articles just state it as fact.  So, maybe it&#8217;s not 508.  Maybe it&#8217;s actually 505&#8230;</p>
            </div>
        
            <p class="meta">
              
                Tags 
                
                  <a href="/articles/tag/bookmarklet" rel="tag">bookmarklet</a>, 
                
                  <a href="/articles/tag/browser" rel="tag">browser</a>, 
                
                  <a href="/articles/tag/explorer" rel="tag">explorer</a>, 
                
                  <a href="/articles/tag/internet" rel="tag">internet</a>, 
                
                  <a href="/articles/tag/internet-explorer" rel="tag">internet-explorer</a>, 
                
                  <a href="/articles/tag/javascript" rel="tag">javascript</a>, 
                
                  <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                
                  <a href="/articles/tag/url" rel="tag">url</a>, 
                
              
            </p>
          
            <div class="post">
              <h2>
                <a href="/articles/2007/10/19/a-common-pattern-in-retailers-receipt-pages-and-a-microformat-solution">A common pattern in retailers' receipt pages (and a microformat solution)</a>
              </h2>
              <p class="auth">
                Posted by Chris Roos
                <span class="typo_date" title="Fri, 19 Oct 2007 07:58:00">
                  Fri, 19 Oct 2007 07:58:00
                </span>
              </p>
          
              <p>We&#8217;ve been looking at embedding a little bit of javascript in one of our partner&#8217;s receipt pages to send us the details of which products were purchased (using <a href="http://en.wikipedia.org/wiki/Stock_Keeping_Unit">SKUs</a>).  A quick glance over the page revealed that nine other providers (<a href="http://www.google.com/analytics/">GA</a>, an <a href="http://en.wikipedia.org/wiki/Search_engine_optimization"><span class="caps">SEO</span></a> helper and a bunch of price comparators) had the same idea.  That&#8217;s the same data repeated nine times.  Ten if you include the human readable copy.  Now that seems like a problem waiting to be solved to me.  It also feels like a perfect fit for <a href="http://microformats.org/">microformats</a>.  If we had a <a href="http://microformats.org/wiki/receipt">receipt microformat</a> then we could use javascript to parse the data rather than having to re-define it each time.  We would also be removing all duplication and creating semantically rich content (I guess that&#8217;s basically what microformats do anyway) in the process.</p>


	<p>So, something that might currently look like this:</p>


<div class="typocode"><pre><code class="typocode_html">&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;Order Number&lt;/th&gt;
    &lt;th&gt;Price&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;1&lt;/td&gt;
    &lt;td&gt;£19.99&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

&lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;
  var order_id = 1
  var price = 1999
&lt;/script&gt;
&lt;script src=&quot;http://MY-PRICE-COMPARATOR&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;

&lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;
  var orderNumber = 1
  var price = 19.99
&lt;/script&gt;
&lt;script src=&quot;http://MY-SEO-HELPER&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;

&lt;!-- And repeat... --&gt;</code></pre></div>

	<p>Could become much simpler:</p>


<div class="typocode"><pre><code class="typocode_html">&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;Order Number&lt;/th&gt;
    &lt;th&gt;Price&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td class=&quot;orderNumber&quot;&gt;1&lt;/td&gt;
    &lt;td class=&quot;orderPrice&quot;&gt;&lt;span class=&quot;orderCurrency&quot;&gt;£&lt;/span&gt;19.99&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

&lt;script src=&quot;http://MY-PRICE-COMPARATOR&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;http://MY-SEO-HELPER&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;</code></pre></div>

	<p>There has been discussion of such a <a href="http://microformats.org/wiki/receipt">receipt microformat</a> but a quick search seemed to suggest that it hasn&#8217;t been discussed in the context of this specific problem.  Maybe I&#8217;ll go add my voice to that discussion&#8230;</p>
            </div>
        
            <p class="meta">
              
                Tags 
                
                  <a href="/articles/tag/commerce" rel="tag">commerce</a>, 
                
                  <a href="/articles/tag/javascript" rel="tag">javascript</a>, 
                
                  <a href="/articles/tag/microformat" rel="tag">microformat</a>, 
                
                  <a href="/articles/tag/receipt" rel="tag">receipt</a>, 
                
                  <a href="/articles/tag/retail" rel="tag">retail</a>, 
                
              
            </p>
          
            <div class="post">
              <h2>
                <a href="/articles/2007/10/03/finding-similar-sites-by-mining-the-del-icio-us-data">Finding similar sites by mining the del.icio.us data</a>
              </h2>
              <p class="auth">
                Posted by Chris Roos
                <span class="typo_date" title="Wed, 03 Oct 2007 08:00:00">
                  Wed, 03 Oct 2007 08:00:00
                </span>
              </p>
          
              <p>So this is very much proof of concept and definitely not very useful in its current form&#8230;</p>


	<p>You need to execute this javascript in the context of a webpage.  In <a href="http://getfirebug.com/">firebug</a> (for example), paste it into the console and run.</p>


<div class="typocode"><pre><code class="typocode_javascript">// Execute this within an existing webpage, using, for example, firebug console
function includeDelicious() {
  function loadScript(scriptUrl) {
    var scriptTag = document.createElement('script');
    scriptTag.setAttribute('type', 'text/javascript');
    scriptTag.src = scriptUrl;
    document.body.appendChild(scriptTag);
  }
  loadScript('http://s3.amazonaws.com/seagul/delicious.js');
}
if (typeof(getRelatedPosts) != 'function') { includeDelicious(); }</code></pre></div>

	<p>The javascript above loads this <a href="http://s3.amazonaws.com/seagul/delicious.js">script</a> that in turn loads <a href="http://s3.amazonaws.com/seagul/md5.js">md5.js</a>,  <a href="http://s3.amazonaws.com/seagul/jquery.js">jquery.js</a>, does some magic with the <a href="http://del.icio.us">del.icio.us</a> <a href="http://www.json.org">json</a> <a href="http://del.icio.us/help/json/">feeds</a> before finally writing some &#8216;similar&#8217; sites to the bottom of the page you&#8217;re currently looking.  At the moment it finds the three most recent sites you&#8217;ve bookmarked for each of the tags that people have used when bookmarking the site you&#8217;re looking at.  It writes all this to the bottom of the current page, as this <a href="http://flickr.com/photos/chrisjroos/1474875125/">screenshot</a> shows.</p>


	<p>Lots of things to do before this could possibly be deemed useful but I think it&#8217;s got some potential.</p>
            </div>
        
            <p class="meta">
              
                Tags 
                
                  <a href="/articles/tag/del.icio.us" rel="tag">del.icio.us</a>, 
                
                  <a href="/articles/tag/dom" rel="tag">dom</a>, 
                
                  <a href="/articles/tag/javascript" rel="tag">javascript</a>, 
                
              
            </p>
          
            <div class="post">
              <h2>
                <a href="/articles/2007/04/11/getting-to-grips-with-pwdhash">Getting to grips with pwdhash</a>
              </h2>
              <p class="auth">
                Posted by Chris Roos
                <span class="typo_date" title="Wed, 11 Apr 2007 22:27:00">
                  Wed, 11 Apr 2007 22:27:00
                </span>
              </p>
          
              <h3>Overview</h3>


	<p>Having used <a href="http://www.pwdhash.com">pwdhash</a> for a while, I decided it was about time I dived into the implementation to see what was actually going on.  I figured that the best way for me to get an understanding of the library was to translate it from <a href="http://en.wikipedia.org/wiki/Javascript">javascript</a> to <a href="http://www.ruby-lang.org">ruby</a>.</p>


	<h3>Investigating the javascript libraries</h3>


	<p>The first step was to create a basic environment within which I could explore the existing javascript functionality.  Relying on <a href="http://www.getfirebug.com/">Firebug</a> to provide a javascript console, this was as simple as creating a very basic html page.</p>


<div class="typocode"><pre><code class="typocode_default">&lt;html&gt;
  &lt;head&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;md5.js&quot; /&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;hashed-password.js&quot; /&gt;
    &lt;title&gt;pwdhash client&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre></div>

	<p>It actually took me a good few minutes to get up and running with this environment.  It seems that <a href="http://crypto.stanford.edu/PwdHash/RemotePwdHash/hashed-password.js">hashed-password.js</a> relies on a variable, <span class="caps">SPH</span>_kPasswordPrefix, being defined.  Although defined in <a href="http://crypto.stanford.edu/PwdHash/RemotePwdHash/pwdhash.js">pwdhash.js</a>, it turns out to be our only dependency on that file.  In wanting to keep the environment as simple as possible, I chose to copy the definition of that variable to hashed-password.js, allowing us to remain independent of pwdhash.js.</p>


	<h3>Starting to implement the javascript functions in ruby</h3>


	<p>Knowing that <a href="http://pajhome.org.uk/crypt/md5/md5src.html">md5.js</a> implemented pretty standard <a href="http://en.wikipedia.org/wiki/Md5">md5</a> (<a href="http://www.faqs.org/rfcs/rfc1321.html">rfc</a>) and <a href="http://en.wikipedia.org/wiki/Hmac">hmac</a> (<a href="http://www.faqs.org/rfcs/rfc2104.html">rfc</a>) routines, for which there are equivalents in ruby, I chose to concentrate on translating hashed-password.js.  Although the code is pretty simple, it took me a while to understand because of my limited javascript knowledge.  We essentially construct an object (SPH_HashedPassword), supplying it with password and realm (domain), that generates, and represents, the hashed password.</p>


	<p>The very first thing that a newly created <span class="caps">SPH</span>_HashedPassword does, is to use the b64_hmac_md5 function, supplied in the md5.js library, to generate the initial hash.  I really didn&#8217;t expect to be tripped up quite this early on, but I just couldn&#8217;t replicate the value obtained from b64_hmac_md5 (using <a href="http://ruby-doc.org/stdlib/libdoc/digest/rdoc/index.html">digest/md5</a> and <a href="http://deisui.org/~ueno/ruby/hmac.html">ruby-hmac</a>.)  I now realise that I didn&#8217;t fully understand what I was actually trying to replicate &#8211; I really should have paid more attention to those three little letters (b64 / <a href="http://www.faqs.org/rfcs/rfc3548.html">base64</a>) at the beginning of the function name&#8230;</p>


	<h3>Back to the drawing-board &#8211; starting to implement the md5.js library in ruby</h3>


	<p>Without thinking about it as much as I should have, I decided that maybe I needed to implement the functionality provided in md5.js in ruby (<a href="http://chrisroos.googlecode.com/svn/trunk/pwdhash-rb/md5-rb/md5.rb">code</a> for reference).  I dived in and started replicating one function at a time.  All was going OK until I came across the <a href="http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Guide:Operators:Bitwise_Operators#Bitwise_Shift_Operators">zero fill right shift</a> bitwise operator in javascript.  There is no standard equivalent in ruby, but a little help from the <a href="http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-talk/144877">mailing list</a> allowed me to come up with this implementation.</p>


<div class="typocode"><pre><code class="typocode_default">class Integer
  def zero_fill_right_shift(count)
    (self &gt;&gt; count) &amp; ((2 ** (size_in_bits-count))-1) # defined in Integer, size_in_bits is self.size * 8
  end
end</code></pre></div>

	<p>Although this allowed me to move a little further, progress completely ground to a halt when trying to replicate the bit_rol function.  It seems that bitwise left-shifting by a negative number offers a different result in javascript and ruby.</p>


<div class="typocode"><pre><code class="typocode_default">javascript: 1 &lt;&lt; -1 = -2147483648
ruby: 1 &lt;&lt; -1 = 0</code></pre></div>

	<h3>Back to the drawing-board (again) &#8211; using digest/md5 and ruby-hmac to replicate the results given by md5.js</h3>


	<p>This time, I decided to break the b64_hmac_md5 function down into its component parts and see which, if any, differed between ruby and javascript.  The first step was to compare the hex output of a simple md5 of a string.</p>


<div class="typocode"><pre><code class="typocode_default">javascript: hex_md5(text) =&gt; &quot;1cb251ec0d568de6a929b520c4aed8d1&quot;
ruby: Digest::MD5.new(text).hexdigest =&gt; 1cb251ec0d568de6a929b520c4aed8d1</code></pre></div>

	<p>Next up was a comparison of an <span class="caps">HMAC MD5</span> of a key and some data.</p>


<div class="typocode"><pre><code class="typocode_default">javascript: hex_hmac_md5(key, data) =&gt; &quot;9d5c73ef85594d34ec4438b7c97e51d8&quot;
ruby: HMAC::MD5.hexdigest(key, data) =&gt; &quot;9d5c73ef85594d34ec4438b7c97e51d8&quot;</code></pre></div>

	<p>Although we can easily replicate the result of hex_hmac_md5 in ruby, we actually want to replicate the result of b64_hmac_md5 (i.e. the hashed data encoded in base64 representation.)
With a bit of thinking, and some trial and error, I realised that I needed to calculate the binary digest of the key and data, and then base64 encode the result.  <strong>Note</strong>.  My original problems arose when comparing the output of the binary string data, what with Javascript being able to display unicode characters and ruby just displaying their code points in octal representation.</p>


<div class="typocode"><pre><code class="typocode_default">javascript: b64_hmac_md5(key, data) =&gt; &quot;nVxz74VZTTTsRDi3yX5R2A&quot;
ruby: # This requires both ruby-hmac and base64
ruby: Base64.encode64(HMAC::MD5.digest(key, data)) =&gt; &quot;nVxz74VZTTTsRDi3yX5R2A==&quot;</code></pre></div>

	<p>This is the first time we see any difference in the values obtained from javascript and ruby.  It turns out that there&#8217;s a clue to this difference in the md5.js library:</p>


<div class="typocode"><pre><code class="typocode_default">var b64pad  = &quot;&quot;; /* base-64 pad character. &quot;=&quot; for strict RFC compliance   */</code></pre></div>

	<p>Ok, so it seems I should just be able to remove the pad characters (=) from my generated hash and I&#8217;ll achieve the same value.  Happy that this was a pretty easy difference to resolve, I could move forward with actually implementing the pwdhash magic in ruby&#8230;</p>


	<h3>Implementing the pwdhash magic in ruby</h3>


	<p>The pwdhash specific stuff is actually very simple.  It alters the initial base 64 encoded hash to ensure that we have:</p>


	<ul>
	<li>One upper case char</li>
		<li>One lower case char</li>
		<li>One non alpha-numeric char</li>
		<li>One number</li>
	</ul>


	<p>So, having got over the first hurdle, the remainder of the translation was pretty simple.  In fact, in its current <a href="http://chrisroos.googlecode.com/svn/trunk/pwdhash-rb/pwdhash.rb">incarnation</a> (revision 62), there are only a few small syntactical differences between the javascript and ruby versions.</p>


	<h3>Next steps</h3>


	<p>Rubify the code.  Although I&#8217;ve copied it almost directly from the javascript I think I&#8217;ve actually managed to make it slightly less readable.</p>


	<p>Investigate the whole world of <a href="http://www.unicode.org">unicode</a> a bit more &#8211; I definitely don&#8217;t know as much about it as I should.</p>
            </div>
        
            <p class="meta">
              
                Tags 
                
                  <a href="/articles/tag/hashing" rel="tag">hashing</a>, 
                
                  <a href="/articles/tag/hmac" rel="tag">hmac</a>, 
                
                  <a href="/articles/tag/javascript" rel="tag">javascript</a>, 
                
                  <a href="/articles/tag/md5" rel="tag">md5</a>, 
                
                  <a href="/articles/tag/pwdhash" rel="tag">pwdhash</a>, 
                
                  <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                
              
            </p>
          

        </div>

        <div id="sidebar">

          <div class="sidebar-node">
            <h3>Syndicate</h3>
            <a href="http://feeds.feedburner.com/DeferredUntilInspirationHits" title="Subscribe to my feed, deferred until inspiration hits" rel="alternate" type="application/rss+xml">
              <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="border:0"/> 
              Subscribe to the feed
            </a>
          </div>

        </div>

        <br clear="all" />

      </div>
    
      <div id="footer">
      </div>

    </div>
  
  </body>

</html>