<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta name="microid" content="ff511e16d7108be450fccd6f4611cf8d1d5416d1" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/DeferredUntilInspirationHits" />
    <link rel="stylesheet" href="/stylesheets/azure.css" media="all" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/print.css" media="print" type="text/css" />
    <link rel="openid.server" href="http://www.myopenid.com/server"/>
    <link rel="openid.delegate" href="http://chrisroos.myopenid.com/"/>
    <title>Posts published in May 2006 - deferred until inspiration hits</title>
  </head>

  <body>
  
    <div id="container" class="clearfix">
    
      <div id="header">
        <div id="logo">
          <h1 id="sitename"><a href="/">deferred until inspiration hits</a></h1>
        </div>
      </div>

      <div id="search">
      </div>

      <div id="content" class="clearfix">

        <div id="main">

          
            <div class="post">
              <h2>
                <a href="/articles/2006/05/13/improving-search-results">Improving search results</a>
              </h2>
              <p class="auth">
                Posted by Chris Roos
                <span class="typo_date" title="Sat, 13 May 2006 07:44:00">
                  Sat, 13 May 2006 07:44:00
                </span>
              </p>
          
              <p>This will be obvious to most people, especially anyone that&#8217;s taken the slightest bit of interest in their search engine rankings.  If text in the url matches the search query then that page is likely to get ranked higher than a page where the only the body matches the search query.</p>


	<p>There is an <a href="http://blog.claimid.com/2006/05/tips-and-tricks-your-name-in-the-url/">explanation</a> from the <a href="http://www.claimid.com">claimid</a> folks or you can see it for yourself by <a href="http://www.google.co.uk/search?hl=en&#38;q=chris+roos&#38;btnG=Google+Search">googling for me</a>.  My <a href="http://www.odeo.com">odeo</a> profile appears third in the results (as of right now).  The url contains my name but apart from that it is essentially a blank page containing no info about me.</p>


	<p>Anyhoo, the main point of this was to say that I emailed the claimid folks this morning to request they change my username from chrisjroos (my common moniker) to chrisroos.  I&#8217;m not even exaggerating when I say that they&#8217;d made the change and replied within ten minutes of my request.  That&#8217;s fantastic service.</p>
            </div>
        
            <p class="meta">
              
                Tags 
                
                  <a href="/articles/tag/identity" rel="tag">identity</a>, 
                
                  <a href="/articles/tag/seo" rel="tag">seo</a>, 
                
              
            </p>
          
            <div class="post">
              <h2>
                <a href="/articles/2006/05/12/using-active-record-models-in-rails-migrations">Using active record models in rails migrations</a>
              </h2>
              <p class="auth">
                Posted by Chris Roos
                <span class="typo_date" title="Fri, 12 May 2006 16:32:00">
                  Fri, 12 May 2006 16:32:00
                </span>
              </p>
          
              <p>I seem to remember that <a href="http://www.reevoo.com">we</a> first came across the &#8220;migrations out of sync with code&#8221; problems around the time that Scott Laird <a href="http://scottstuff.net/blog/articles/2005/10/31/migrating-in-two-dimensions">posted</a> about it regarding <a href="http://www.typosphere.org">typo</a>.</p>


	<p>Having just read <a href="http://www.reevoo.com/blogs/bengriffiths">Ben&#8217;s</a> <a href="http://www.reevoo.com/blogs/bengriffiths/2006/05/10/misrepresenting-rails-reliability/">post</a> about rails reliability, I was reminded again about the pitfalls of using model code in migrations.</p>


	<blockquote>
		<p>&#8220;Migrations can be problematic if the code under which the migration was written changes before the migration is deployed and released.&#8221;</p>
	</blockquote>


	<p>We&#8217;re a small team working on the same codebase, yet we still get bitten relatively frequently.  A while back we started to re-define our AR classes within our migrations to ensure that we weren&#8217;t relying on model code.  This has been <a href="http://rails.techno-weenie.net/tip/2006/2/23/safely_using_models_in_migrations">documented</a> <a href="http://wrath.rubyonrails.org/pipermail/rails-core/2006-February/000830.html">elsewhere</a>.  The typo codebase has gone slightly further and created a <a href="http://www.typosphere.org/trac/browser/trunk/lib/bare_migration.rb">BareMigration module</a> that takes care of some magic for you.  To be fair, I haven&#8217;t looked in detail so am not entirely sure what it does..</p>


	<p>The problem with re-defining models in the migrations is that it relies on you remembering to re-define them (I&#8217;m good at &#8216;forgetting&#8217; to do things unless I really have to).  There is nothing to stop you using the real models; that is, until someone complains that the migrations are broken and you have to fix it.</p>


	<p>We are currently using a slightly more robust (I think) solution that forces you to re-define any AR models that you wish to use in migrations.  It does this by hijacking the &#8216;zero&#8217; migration (a migration starting with 0 that gets loaded along with all other migrations but doesn&#8217;t interfere in any other way) to ensure any AR derived classes are defined in a module.  It&#8217;s naive but seems to work ok.</p>


	<p>If you don&#8217;t already have a zero migration, then create one.  The name is important as you will need to create an empty class of the same name in the file itself (for migrations to be happy).  Ours is called 000_rails_ext.rb.  The code is below.  Our code isn&#8217;t identical (yet) as I just realised that we had an ineffective call to super in the inherited method, now replaced with alias_method.</p>


<div class="typocode"><pre><code class="typocode_ruby">  <span class="keyword">class </span><span class="class">RailsExt</span>
  <span class="keyword">end</span>

  <span class="keyword">class </span><span class="class">ActiveRecord::Base</span>
    <span class="keyword">class </span><span class="punct">&lt;&lt;</span> <span class="constant">self</span>
      <span class="ident">alias_method</span> <span class="symbol">:__original__inherited</span><span class="punct">,</span> <span class="symbol">:inherited</span>
      <span class="keyword">def </span><span class="method">inherited</span><span class="punct">(</span><span class="ident">base</span><span class="punct">)</span>
        <span class="keyword">raise</span> <span class="punct">&quot;</span><span class="string">You're trying to use an ActiveRecord::Base derived class (--<span class="expr">#{base}</span>--) that is not defined in this migration.</span><span class="punct">&quot;</span> <span class="keyword">unless</span> <span class="ident">base</span><span class="punct">.</span><span class="ident">to_s</span> <span class="punct">=~</span> <span class="punct">/</span><span class="regex">^Migration.*</span><span class="punct">/</span>
        <span class="ident">__original__inherited</span><span class="punct">(</span><span class="ident">base</span><span class="punct">)</span>
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="constant">Dispatcher</span><span class="punct">.</span><span class="ident">reset_application!</span></code></pre></div>

	<p>The inherited callback is triggered everytime we define a class that inherits from ActiveRecord::Base.  All we do is check that its name starts with Migration and raise an error if not (failing fast is good).  The name is the fully qualified name and so includes namespaces.  This is good as it allows us to place all re-defined classes in a module named Migration&lt;number&gt;.  This module can then be included in the migration class itself.  Although I can&#8217;t remember exactly now, I think the reason we need to reset_application! is because we have some calls to our models in environment.rb.  These models would already be loaded and therefore any future references to them (in the migrations) would bypass our custom inherited method.  By resetting the app, we are sure that we have no AR models loaded.</p>


	<p>To re-define the models in the migration, we use something like..</p>


<div class="typocode"><pre><code class="typocode_ruby">  <span class="keyword">class </span><span class="class">MyFirstMigration</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Migration</span>
    <span class="keyword">def </span><span class="method">self.up</span>
    <span class="keyword">end</span>
    <span class="keyword">def </span><span class="method">self.down</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">module </span><span class="module">Migration001</span>
    <span class="keyword">class </span><span class="class">Person</span> <span class="punct">&lt;</span> <span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="constant">MyFirstMigration</span><span class="punct">.</span><span class="ident">send</span><span class="punct">(</span><span class="symbol">:include</span><span class="punct">,</span> <span class="constant">Migration001</span><span class="punct">)</span></code></pre></div>

	<p>Although sending the migration class the include message with the module isn&#8217;t great, we use it as it allows us to re-define all our classes below the actual migration.  If we were to place the module at the top then this wouldn&#8217;t be required but I feel that it gets in the way of being able to read the migration clearly.</p>


	<h3>A problem with this method and re-defining classes directly in the migration</h3>


	<p>Both methods create AR derived classes in a namespace that isn&#8217;t the root namespace.  We came across a problem where we were serializing the contents of one of these re-defined classes to the database from within our migration.  When we came to read the serialized data in our code, it didn&#8217;t &#8216;know&#8217; what a Migration001::Person was and so raised an exception.  Without thinking about it too much, I think this might cause problems with <span class="caps">STI</span> too (I&#8217;ve seen notes to this effect from the Typo migration solution).</p>
            </div>
        
            <p class="meta">
              
                Tags 
                
                  <a href="/articles/tag/migrations" rel="tag">migrations</a>, 
                
                  <a href="/articles/tag/rails" rel="tag">rails</a>, 
                
                  <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
                
              
            </p>
          
            <div class="post">
              <h2>
                <a href="/articles/2006/05/06/storing-passwords-online">Storing passwords online</a>
              </h2>
              <p class="auth">
                Posted by Chris Roos
                <span class="typo_date" title="Sat, 06 May 2006 10:05:00">
                  Sat, 06 May 2006 10:05:00
                </span>
              </p>
          
              <p>I regularly access the Internet from three different locations.  Quite often, I will log into my bank account or other sites that have complicated login procedures (i.e. require more than just username and password) from each of these sites.  I&#8217;m not good at remembering this stuff so used to have it stored in some software called <a href="http://www.iliumsoft.com/site/ew/ewallet.html">eWallet</a> on the Pc.  This was fine when I was on one computer most of the time but as soon as I started using multiple computers, including a Mac, it became problematic.</p>


	<p>To get around the multiple computer problem, I ditched eWallet and now store all my info online, in a self-hosted slightly customised version of <a href="http://www.instiki.org">instiki</a>.  To achieve this in what I hope is some kind of secure way, I encrypt each set of data using <a href="http://www.gnupg.org">gpg</a>.  I then store this data in its own wiki page.  The wiki itself has very basic password protection and is not hosted over ssl but I&#8217;m thinking that because the decryption takes place on the client I should be ok.  Granted, it means that my secret key is on three computers and could therefore be compromised but I hope this is unlikely&#8230;</p>


	<p>The (hopefully) constant availability of my data outweighs the slight pain caused by having to decrypt the data each time.</p>


	<p>I&#8217;m genuinely not sure if this is a great idea or not regards security so maybe someone cleverer than I could advise if you come across this&#8230;</p>
            </div>
        
            <p class="meta">
              
            </p>
          

        </div>

        <div id="sidebar">

          <div class="sidebar-node">
            <h3>Syndicate</h3>
            <a href="http://feeds.feedburner.com/DeferredUntilInspirationHits" title="Subscribe to my feed, deferred until inspiration hits" rel="alternate" type="application/rss+xml">
              <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="border:0"/> 
              Subscribe to the feed
            </a>
          </div>

        </div>

        <br clear="all" />

      </div>
    
      <div id="footer">
      </div>

    </div>
  
  </body>

</html>