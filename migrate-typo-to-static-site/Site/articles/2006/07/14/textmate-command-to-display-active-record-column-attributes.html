<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta name="microid" content="ff511e16d7108be450fccd6f4611cf8d1d5416d1" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/DeferredUntilInspirationHits" />
    <link rel="stylesheet" href="/stylesheets/azure.css" media="all" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/print.css" media="print" type="text/css" />
    <link rel="openid.server" href="http://www.myopenid.com/server"/>
    <link rel="openid.delegate" href="http://chrisroos.myopenid.com/"/>
    <title>Textmate command to display Active Record column attributes - deferred until inspiration hits</title>
  </head>

  <body>
  
    <div id="container" class="clearfix">
    
      <div id="header">
        <div id="logo">
          <h1 id="sitename"><a href="/">deferred until inspiration hits</a></h1>
        </div>
      </div>

      <div id="search">
      </div>

      <div id="content" class="clearfix">

        <div id="main">

          <div class="post">
            <h2>Textmate command to display Active Record column attributes</h2>
            <p class="auth">
              Posted by Chris Roos
              <span class="typo_date" title="Fri, 14 Jul 2006 08:18:00">
                Fri, 14 Jul 2006 08:18:00
              </span>
            </p>
          
            <p>I find myself constantly visiting either the console or the mysql command line to check out the attributes (columns) of <a href="http://api.rubyonrails.com/classes/ActiveRecord/Base.html">active record</a> objects.</p>


	<p>I know there is a <a href="http://blogs.pragprog.com/cgi-bin/pragdave.cgi/Tech/Ruby/AnnotateModels.rdoc">plugin</a> by <a href="http://blogs.pragprog.com/cgi-bin/pragdave.cgi">Dave Thomas</a> that places the table structure within the model code itself.  To be honest I&#8217;ve never tried this and it might well suffice (although I&#8217;m not 100% convinced I like the idea).</p>


	<p>Anyhoo, I just spent some time whilst on the train hacking together a basic <a href="http://macromates.com/">textmate</a> command that displays a tooltip containing the table structure.  It&#8217;s very basic (though you wouldn&#8217;t have thought it based on the amount of time it took me together<sup><a href="#fn1">1</a></sup>); but seems to work ok.</p>


	<p><img src="http://farm1.static.flickr.com/236/460082493_49ff4cd1ed_o.png" alt="" /></p>


	<p>The code is below.  You&#8217;ll need to add a ruby command in the ruby textmate bundle, setting the intput to &#8216;selected text&#8217; or &#8216;nothing&#8217;, the output to &#8216;show as tooltip&#8217; and preferably a hotkey that isn&#8217;t one of the ones you use every day (however tempting that is).</p>


<div class="typocode"><pre><code class="typocode_ruby"><span class="comment">#! /usr/local/bin/ruby</span>

<span class="ident">project</span> <span class="punct">=</span> <span class="constant">ENV</span><span class="punct">['</span><span class="string">TM_PROJECT_DIRECTORY</span><span class="punct">']</span>
<span class="ident">word</span> <span class="punct">=</span> <span class="constant">ENV</span><span class="punct">['</span><span class="string">TM_CURRENT_WORD</span><span class="punct">']</span>

<span class="ident">require</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{project}</span>/config/boot</span><span class="punct">&quot;</span>
<span class="ident">require</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{project}</span>/config/environment</span><span class="punct">&quot;</span>

<span class="ident">klass</span> <span class="punct">=</span> <span class="constant">Object</span><span class="punct">.</span><span class="ident">const_get</span><span class="punct">(</span><span class="ident">word</span><span class="punct">)</span> <span class="keyword">rescue</span> <span class="constant">nil</span>
<span class="keyword">if</span> <span class="ident">klass</span> <span class="keyword">and</span> <span class="ident">klass</span><span class="punct">.</span><span class="keyword">class </span><span class="class">==</span> <span class="ident">Class</span> <span class="ident">and</span> <span class="ident">klass</span><span class="punct">.</span><span class="ident">ancestors</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span><span class="punct">)</span>
  <span class="ident">columns</span> <span class="punct">=</span> <span class="ident">klass</span><span class="punct">.</span><span class="ident">columns_hash</span>

  <span class="ident">data</span> <span class="punct">=</span> <span class="punct">[]</span>
  <span class="ident">data</span> <span class="punct">+=</span> <span class="punct">[%w[</span><span class="string">column primary sql_type default</span><span class="punct">]]</span>
  <span class="ident">data</span> <span class="punct">+=</span> <span class="punct">[%w[</span><span class="string">------ ------- -------- -------</span><span class="punct">]]</span>
  <span class="ident">data</span> <span class="punct">+=</span> <span class="ident">columns</span><span class="punct">.</span><span class="ident">collect</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">col</span><span class="punct">,</span> <span class="ident">attrs</span><span class="punct">|</span> <span class="punct">[</span><span class="ident">col</span><span class="punct">,</span> <span class="ident">attrs</span><span class="punct">.</span><span class="ident">primary</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="ident">attrs</span><span class="punct">.</span><span class="ident">sql_type</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">,</span> <span class="ident">attrs</span><span class="punct">.</span><span class="ident">default</span><span class="punct">.</span><span class="ident">to_s</span><span class="punct">]</span> <span class="punct">}</span>

  <span class="constant">STDOUT</span> <span class="punct">&lt;&lt;</span> <span class="ident">data</span><span class="punct">.</span><span class="ident">inject</span><span class="punct">('</span><span class="string"></span><span class="punct">')</span> <span class="keyword">do</span> <span class="punct">|</span><span class="ident">output</span><span class="punct">,</span> <span class="ident">array</span><span class="punct">|</span> 
    <span class="ident">output</span> <span class="punct">+</span> <span class="ident">array</span><span class="punct">.</span><span class="ident">inject</span><span class="punct">('</span><span class="string"></span><span class="punct">')</span> <span class="punct">{</span> <span class="punct">|</span><span class="ident">row_str</span><span class="punct">,</span> <span class="ident">value</span><span class="punct">|</span> <span class="ident">row_str</span> <span class="punct">+</span> <span class="ident">value</span><span class="punct">.</span><span class="ident">ljust</span><span class="punct">(</span><span class="number">20</span><span class="punct">)</span> <span class="punct">}</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string"><span class="escape">\n</span></span><span class="punct">&quot;</span>
  <span class="keyword">end</span>
<span class="keyword">elsif</span> <span class="ident">klass</span> <span class="keyword">and</span> <span class="ident">klass</span><span class="punct">.</span><span class="keyword">class </span><span class="class">==</span> <span class="ident">Class</span> <span class="ident">and</span> <span class="keyword">not</span> <span class="ident">klass</span><span class="punct">.</span><span class="ident">ancestors</span><span class="punct">.</span><span class="ident">include?</span><span class="punct">(</span><span class="constant">ActiveRecord</span><span class="punct">::</span><span class="constant">Base</span><span class="punct">)</span>
  <span class="constant">STDOUT</span> <span class="punct">&lt;&lt;</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{word}</span> is not an Active Record derived class</span><span class="punct">&quot;</span>
<span class="keyword">else</span>
  <span class="constant">STDOUT</span> <span class="punct">&lt;&lt;</span> <span class="punct">&quot;</span><span class="string"><span class="expr">#{word}</span> was not recognised as a class</span><span class="punct">&quot;</span>
<span class="keyword">end</span></code></pre></div>

	<p>It relies on you having your entire rails project (the folder right above app, config, script etc) open in textmate (in order to find the config files).  With that, just click on the name of an active record class (it has to be the actual class name at present, it&#8217;d be cool if it also worked based on the class definition you are currently in too) and hit your hotkey of choice (best to use the one you assigned to this command).  Hey presto, a tooltip containing your table structure.</p>


	<p>One odd thing I&#8217;ve noticed is that it never recognises standard class constants.  It should display &#8216;this is not an active record derived class&#8217; but instead always displays &#8216;was not recognised as a class&#8217;.  Oh well.</p>


	<p>Anyone find this remotely useful or want to finish off what I&#8217;ve started?</p>


	<p>[1] I spent ages trying to develop within the textmate bundle editor before realising it&#8217;d be a helluva lot quicker and easier to develop in textmate proper.  Hmmm.</p>
          </div>
        
          <p class="meta">
            
              Tags 
              
                <a href="/articles/tag/activerecord" rel="tag">activerecord</a>, 
              
                <a href="/articles/tag/rails" rel="tag">rails</a>, 
              
                <a href="/articles/tag/ruby" rel="tag">ruby</a>, 
              
                <a href="/articles/tag/textmate" rel="tag">textmate</a>, 
              
            
          </p>
          
          <div id="disqus_thread"></div>
          <script type="text/javascript" src="http://disqus.com/forums/deferred-until-inspiration-hits/embed.js"></script>
          <noscript>
            <a href="http://deferred-until-inspiration-hits.disqus.com/?url=ref">View the forum thread.</a>
          </noscript>

          
            <a name="comments"></a>
            <h4 class="blueblk">Legacy Comments</h4>
            <ol class="comment-list" id="commentList">
              
              <li>
                <cite>
                  <strong>
                    
                      Edward Ocampo-Gooding
                    
                  </strong>
                </cite> said on Sat, 15 Jul 2006 20:22:55:<br />
                <p>That is pretty darn nifty.</p>


	<p>I agree with you in regards to how I think it&#8217;s dangerous to have a plugin copy and paste text into your model, because there&#8217;s nothing that keeps an errant or tired developer from not running the script after every modification from the database.</p>


	<p>It would be safer if there was a hook in the plugin that got it to run on every migration, but for larger projects, it might be painful (although I&#8217;d be surprised if it&#8217;s <strong>really</strong> bad).</p>
              </li>
              
              <li>
                <cite>
                  <strong>
                    
                      <a href="http://octopod.info">Chris McGrath</a>
                    
                  </strong>
                </cite> said on Mon, 17 Jul 2006 15:40:08:<br />
                <p>Very cool and very handy. Thanks!</p>


	<p>I mentioned this to Allan in #textmate and he&#8217;s added it to the Rails bundle.</p>
              </li>
              
              <li>
                <cite>
                  <strong>
                    
                      <a href="http://macromates.com/blog/">Allan Odgaard</a>
                    
                  </strong>
                </cite> said on Mon, 17 Jul 2006 15:40:25:<br />
                <p>I added this to the Rails bundle included with TextMate, hopefully you won’t mind :)</p>


	<p>I gave it a key equivalent of ⌃⇧⌘S (a little convoluted, but presumably this isn’t a frequent action) and placed it in the Model submenu. I also added a progress indicator since it took ~1.5s for me for the tool tip to show.</p>
              </li>
              
              <li>
                <cite>
                  <strong>
                    
                      <a href="http://octopod.info">Chris McGrath</a>
                    
                  </strong>
                </cite> said on Mon, 17 Jul 2006 16:09:26:<br />
                <p><span class="caps">BTW</span>, if you have the Edit in TextMate command installed, you can use it from the bundle editor to open the code in TM itself.</p>
              </li>
              
              <li>
                <cite>
                  <strong>
                    
                      <a href="http://www.pinupgeek.com">Rodney</a>
                    
                  </strong>
                </cite> said on Mon, 17 Jul 2006 18:05:49:<br />
                <p>I&#8217;m hooked already. What could you possibly do to make it better :-) ?</p>
              </li>
              
              <li>
                <cite>
                  <strong>
                    
                      Chris
                    
                  </strong>
                </cite> said on Mon, 17 Jul 2006 18:21:51:<br />
                <p>@Chris &#8211; Thanks for mentioning it to Allan.</p>


	<p>@Allan &#8211; It&#8217;s great that it&#8217;s included in the rails bundle.</p>


	<p>I&#8217;m just glad it&#8217;s proving useful to others too.</p>
              </li>
              
              <li>
                <cite>
                  <strong>
                    
                      <a href="http://leftjoinrightjoin.com">Ryan Allen</a>
                    
                  </strong>
                </cite> said on Tue, 18 Jul 2006 00:42:27:<br />
                <p>Rodney: To make it better, 1. not load the whole rails environment to get the attributes, 2. support set_table_name :)</p>


	<p>But nice one! Textmate just updated so I imagine I&#8217;ve already got it!</p>
              </li>
              
              <li>
                <cite>
                  <strong>
                    
                      <a href="http://leftjoinrightjoin.com">Ryan Allen</a>
                    
                  </strong>
                </cite> said on Tue, 18 Jul 2006 00:43:57:<br />
                <p>Oh wait, my bad!</p>


	<p>You&#8217;re getting the columns from ActiveRecord itself so it does work with set_table_name!</p>
              </li>
              
              <li>
                <cite>
                  <strong>
                    
                      <a href="http://www.lukeredpath.co.uk">Luke Redpath</a>
                    
                  </strong>
                </cite> said on Thu, 27 Jul 2006 13:18:48:<br />
                <p>Chris &#8211; this is really useful. Finally I can get rid of those crufty annotations &#8211; they served their purpose but its time to say goodbye ;)</p>
              </li>
              
              <li>
                <cite>
                  <strong>
                    
                      <a href="http://www.fearoffish.co.uk/">Jamie van Dyke</a>
                    
                  </strong>
                </cite> said on Thu, 10 Aug 2006 13:51:27:<br />
                <p>That&#8217;s handy to say the least, opening a console to double check becomes so tiresome&#8230;even if I use Visor.</p>
              </li>
              
              <li>
                <cite>
                  <strong>
                    
                      Ben
                    
                  </strong>
                </cite> said on Fri, 11 Aug 2006 17:45:03:<br />
                <p>Perhaps this should be improved so it doesn&#8217;t load the entire Rails framework. I think the config parsing and the ActiveRecord module would be enough. Can someone confirm this ?</p>


	<p>I only have a pbook g4. Booting Rails entirely takes a few seconds&#8230; I&#8217;d expect something faster for a TextMate tooltip :)</p>
              </li>
              
            </ol>
          

        </div>

        <div id="sidebar">

          <div class="sidebar-node">
            <h3>Syndicate</h3>
            <a href="http://feeds.feedburner.com/DeferredUntilInspirationHits" title="Subscribe to my feed, deferred until inspiration hits" rel="alternate" type="application/rss+xml">
              <img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="border:0"/> 
              Subscribe to the feed
            </a>
          </div>

        </div>

        <br clear="all" />

      </div>
    
      <div id="footer">
      </div>

    </div>
  
  </body>

</html>